@model IEnumerable<ProductViewModel>
@{
    ViewBag.Title = "Bookmark";
}
<!DOCTYPE html>
<html lang="en">
<body>
    <!--=====================================
                  SINGLE BANNER PART START
        =======================================-->
    <section class="single-banner dashboard-banner">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="single-content">
                        <h2>bookmark</h2>
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a class="navigate-link" asp-controller="Dashboard" asp-action="Dashboard">Home</a></li>
                            <li class="breadcrumb-item active" aria-current="page">bookmark</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!--=====================================
              SINGLE BANNER PART END
    =======================================-->
    <!--=====================================
            DASHBOARD HEADER PART START
    =======================================-->
    <section class="dash-header-part">
        <div class="container">
            <div class="dash-header-card">
                <partial name="~/Views/Shared/_ProfileCard.cshtml" />
                <div class="row">
                    <div class="col-lg-12">
                        <div class="dash-menu-list">
                            <ul>
                                <li><a class="navigate-link" asp-controller="User" asp-action="Dashboard">Dashboard</a></li>
                                <li><a class="navigate-link" asp-controller="User" asp-action="Profile">Profile</a></li>
                                <li><a class="navigate-link" asp-controller="User" asp-action="PostAd">Ad Post</a></li>
                                <li><a class="navigate-link" asp-controller="User" asp-action="MyAds">my ads</a></li>
                                <li><a class="navigate-link" asp-controller="User" asp-action="Settings">settings</a></li>
                                <li><a class="navigate-link" asp-controller="User" class="active" asp-action="Bookmark">bookmarks</a></li>
                                <li><a class="navigate-link" asp-controller="User" asp-action="Message">message</a></li>
                                <li><a class="navigate-link" asp-controller="User" asp-action="Notification">notification</a></li>
                                <li><a class="navigate-link" asp-controller="Dashboard" asp-action="Logout">logout</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!--=====================================
            DASHBOARD HEADER PART END
    =======================================-->
    @if (Model.Count() > 0)
    {
        <!--=====================================
                    BOOKMARK PART START
        =======================================-->
        <section class="bookmark-part">
            <div class="container">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="header-filter">
                            <div class="filter-show">
                                <label class="filter-label">Show :</label>
                                <select class="custom-select filter-select">
                                    <option value="1">12</option>
                                    <option value="2">24</option>
                                    <option value="3">36</option>
                                </select>
                            </div>
                            <div class="filter-short">
                                <label class="filter-label">Short by :</label>
                                <select class="custom-select filter-select">
                                    <option selected>all ads</option>
                                    <option value="3">booking ads</option>
                                    <option value="2">rental ads</option>
                                    <option value="1">sale ads</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                @{
                    int itemsPerPage = 12;
                    int currentPage = ViewBag.CurrentPage;
                    double modelCount = Model.Count();
                    var pagedProducts = Model.Skip(itemsPerPage * (currentPage - 1)).Take(itemsPerPage).ToList();
                    int productsOnPage = pagedProducts.Count;
                }

                <div class="row">
                    @foreach (var wishlist in pagedProducts)
                    {
                        <div class="col-sm-6 col-md-6 col-lg-4 col-xl-3">
                            <div class="product-card">
                                <div class="product-media">
                                    <div class="product-img">
                                        <img src="@Url.Action("GetProductImage", "Dashboard", new { productid = wishlist.productId })" onerror="this.onerror=null; this.src='/images/no-image.png';" alt="@wishlist.productImageName" width="288" height="205" />
                                    </div>
                                    <div class="cross-vertical-badge product-badge">
                                        <i class="fas fa-fire"></i>
                                        <span>top niche</span>
                                    </div>
                                    <div class="product-type">
                                        <span class="flat-badge @(wishlist.productAdCategory.ToLower())">@wishlist.productAdCategory</span>
                                    </div>
                                    <ul class="product-action">
                                        @* <li class="view"><i class="fas fa-eye"></i><span>264</span></li>
                                        <li class="click"><i class="fas fa-mouse"></i><span>134</span></li> *@
                                        <li class="rating"><i class="fas fa-star"></i><span>@((wishlist.averageRating != 0) ? @wishlist.averageRating + "/5" : "NA")</span></li>
                                    </ul>
                                </div>
                                <div class="product-content">
                                    <ol class="breadcrumb product-category">
                                        <li><i class="fas fa-tags"></i></li>
                                        <li class="breadcrumb-item"><a href="#">@wishlist.productCategoryName</a></li>
                                        <li class="breadcrumb-item active" aria-current="page">@wishlist.productSubCategoryName</li>
                                    </ol>
                                    <h5 class="product-title">
                                        <a href="#">@wishlist.productName</a>
                                    </h5>
                                    <div class="product-meta">
                                        <span><i class="fas fa-map-marker-alt"></i>@wishlist.userContactCity</span>
                                        <span><i class="fas fa-clock"></i>@wishlist.updatedDate.ToString("dd-MM-yyyy")</span>
                                    </div>
                                    <div class="product-info">
                                        <h5 class="product-price">₹@wishlist.productPrice.ToString("F2")<span>/week</span></h5>
                                        <div class="product-btn">
                                            <a asp-action="ProductDetails" asp-controller="Dashboard" asp-route-username="@wishlist.createdBy" asp-route-productId="@wishlist.productId" title="Compare" class="fas fa-eye"></a>
                                            <a href='#' class='fas fa-compress'
                                               data-toggle='modal' data-target='#productDetailsModal'
                                               onclick='populateModal(@Html.Raw(System.Text.Json.JsonSerializer.Serialize(wishlist)))'>
                                            </a>
                                            <button type="button" title="Wishlist" class="fas fa-heart" onclick="UpdateWishlist(this, '@wishlist.productId', '@wishlist.createdBy')"></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }

                    <div class="row">
                        <div class="col-lg-12">
                            <div class="footer-pagection">
                                <p class="page-info">Showing @((itemsPerPage * ViewBag.CurrentPage < ViewBag.Count) ? itemsPerPage * ViewBag.CurrentPage : ViewBag.Count) of @ViewBag.Count Results</p>
                                <ul class="pagination" id="pagination">
                                    <li class="page-item">
                                        <a class="page-link" onclick="previousPage()">
                                            <i class="fas fa-long-arrow-alt-left"></i>
                                        </a>
                                    </li>
                                    @* Page numbers will be inserted dynamically *@
                                    <li class="page-item">
                                        <a class="page-link" onclick="nextPage()">
                                            <i class="fas fa-long-arrow-alt-right"></i>
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
        </section>
        <!--=====================================
                    BOOKMARK PART END
        =======================================-->
    }
    else
    {
        <div class="text-center m-5">
            <h3>Your Wishlist is Empty</h3>
        </div>
    }
    <div id="spinner" class="d-none">
        <img style="height: 100px" src="~/images/spinner.gif" />
    </div>
    <!--=====================================
              CURRENCY MODAL PART START
    =======================================-->
    <div class="modal fade" id="currency">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h4>Choose a Currency</h4>
                    <button class="fas fa-times" data-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <button class="modal-link active">United States Doller (USD) - $</button>
                    <button class="modal-link">Euro (EUR) - €</button>
                    <button class="modal-link">British Pound (GBP) - £</button>
                    <button class="modal-link">Australian Dollar (AUD) - A$</button>
                    <button class="modal-link">Canadian Dollar (CAD) - C$</button>
                </div>
            </div>
        </div>
    </div>
    <!--=====================================
              CURRENCY MODAL PART END
    =======================================-->
    <!--=====================================
              LANGUAGE MODAL PART END
    =======================================-->
    <div class="modal fade" id="language">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h4>Choose a Language</h4>
                    <button class="fas fa-times" data-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <button class="modal-link active">English</button>
                    <button class="modal-link">bangali</button>
                    <button class="modal-link">arabic</button>
                    <button class="modal-link">germany</button>
                    <button class="modal-link">spanish</button>
                </div>
            </div>
        </div>
    </div>
</body>
<div class="modal fade" id="productDetailsModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLongTitle" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLongTitle" style="color:#06038d">Product Details</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            </div>
            <div class="modal-body d-flex">
                <!-- Left Column: Image and Description -->
                <div class="w-50 pr-4">
                    <div class="comm on-card text-center">
                        <img id="image-modal" src="" style="height: 200px" alt="Image not available" class="img-fluid rounded">
                    </div>
                    <div class="common-card mt-4">
                        <div class="card-header">
                            <h5 class="card-title">Description</h5>
                        </div>
                        <p id="productDescription-modal" class="ad-details-desc"></p>
                    </div>
                </div>
                <!-- Right Column: Specifications -->
                <div class="w-50">
                    <div class="common-card">
                        <div class="card-header">
                            <h5 class="card-title">Specification</h5>
                        </div>
                        <p id="productId-modal" data-product-id="" style="display:none"></p>
                        <ul class="ad-details-specific">
                            <li class="d-flex justify-content-between">
                                <h6>Product Name:</h6>
                                <p id="productName-modal"></p>
                            </li>
                            <li class="d-flex justify-content-between">
                                <h6>Price:</h6>
                                <p id="productPrice-modal"></p>
                            </li>
                            <li class="d-flex justify-content-between">
                                <h6>Quantity:</h6>
                                <p id="productQuantity-modal"></p>
                            </li>
                            <li class="d-flex justify-content-between">
                                <h6>Published at:</h6>
                                <p id="productPublished-modal"></p>
                            </li>
                            <li class="d-flex justify-content-between">
                                <h6>Category:</h6>
                                <p id="productCategory-modal"></p>
                            </li>
                            <li class="d-flex justify-content-between">
                                <h6>Created By:</h6>
                                <p id="productOwner-modal"></p>
                            </li>
                            @* <li class="d-flex justify-content-between">
                                <h6>Ad Status:</h6>
                                <p id="productStatus-modal" data-product-status=""></p>
                            </li> *@
                        </ul>
                    </div>
                    @{
                        var isUserLoggedIn = !string.IsNullOrEmpty(Context.Session.GetString("userName"));
                    }
                    @* <div class="@(isUserLoggedIn ? "" : "d-none")">
                        <div class="card-header">
                            <h5 class="card-title">Submit your Rating</h5>
                        </div>
                        <div id="starRating" class="star-rating" data-selected="0">
                            <span class="fa fa-star rating-size" data-value="5" onclick="selectRating(this)"></span>
                            <span class="fa fa-star rating-size" data-value="4" onclick="selectRating(this)"></span>
                            <span class="fa fa-star rating-size" data-value="3" onclick="selectRating(this)"></span>
                            <span class="fa fa-star rating-size" data-value="2" onclick="selectRating(this)"></span>
                            <span class="fa fa-star rating-size" data-value="1" onclick="selectRating(this)"></span>
                        </div>
                        <input type="hidden" id="selectedRating" name="Rating" value="0" />
                    </div> *@
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
</html>
<script type="text/javascript">
    let totalPages = @Math.Ceiling((double)(Model.Count()) / 12);
    let currentPage = @ViewBag.CurrentPage;
    const visiblePages = 5;

    function UpdateWishlist(button, productID, createdBy) {

        button.classList.replace("fas", "far");
        $('#spinner').removeClass('d-none');
        $.ajax({
            url: '/User/UpdateBookmarks',
            type: 'POST',
            data: { productID: productID, createdBy: createdBy, status: 0},
            success: function (response) {
                setTimeout(() => {
                   $('#spinner').addClass('d-none');
                }, 2000);

                if (response.statusCode == 200) {
                    window.location.href = '@Url.Action("Bookmark", "User")';
                } else {

                }
            },
            error: function () {
                alert('Error in processing request.');
            }
        });
    }

    function loadImage(image, productId) {

        alert(productId);
        image.attr("src", "/images/spinner.gif");
        image.width("20px");

        $.ajax({
            url: '/Dashboard/GetImageDetails',
            type: 'GET',
            data: { productid: productId },
            success: function (response) {
                if (response.image) {
                    image.attr("src", "data:image/jpeg;base64," + response.image); // Set image to base64
                    image.width("300px");
                } else {
                    image.attr("src", "/images/no-image.jpg"); // Fallback if no image found
                }
            },
            error: function () {
                image.attr("src", "/images/error.jpg"); // Fallback if API call fails
            }
        });
    }

    renderPagination();

    function renderPagination() {
        const pagination = document.getElementById('pagination');
        const pageLinks = pagination.querySelectorAll('.page-item');

        // Remove old page number items (excluding arrows)
        pageLinks.forEach((item, index) => {
            if (index !== 0 && index !== pageLinks.length - 1) {
                item.remove();
            }
        });

        // Calculate startPage and endPage with fixed visiblePages
        let half = Math.floor(visiblePages / 2);
        let startPage = currentPage - half;
        let endPage = currentPage + half;

        if (startPage < 1) {
            startPage = 1;
            endPage = visiblePages;
        }

        if (endPage > totalPages) {
            endPage = totalPages;
            startPage = Math.max(1, totalPages - visiblePages + 1);
        }

        const insertBefore = pagination.children[pagination.children.length - 1];

        for (let i = startPage; i <= endPage; i++) {
            const li = document.createElement('li');
            li.className = `page-item ${i === currentPage ? 'active' : ''}`;
            li.innerHTML = `<a class="page-link" onclick="goToPage(${i})">${i}</a>`;
            pagination.insertBefore(li, insertBefore);
        }
    }

    function goToPage(page) {
        currentPage = page;
        renderPagination();
        changePage(page); // Your actual logic to load page content
    }

    function previousPage() {
        if (currentPage > 1) {
            goToPage(currentPage - 1);
        }
    }

    function nextPage() {
        if (currentPage < totalPages) {
            goToPage(currentPage + 1);
        }
    }

    function changePage(page) {
        $('.pagination .page-link').removeClass('active');

        // Add "active" class to the clicked page
        //$(curPage).addClass('active');
        var queryParams = `?page=${encodeURIComponent(page)}`;
        window.location.href = '/User/Bookmark?page=' + page;
    }
</script>
@model List<UserViewModel>
@{
    ViewBag.Title = "Message";
    int currentUserId = Context.Session.GetInt32("UserId") ?? 0;
    var defaultUser = Model.FirstOrDefault();
}
<!DOCTYPE html>
<html lang="en">
<head>
    <!-- VENDOR -->
    <link rel="stylesheet" href="~/css/vendor/nice-select.min.css">
    <link rel="stylesheet" href="~/css/vendor/emojionearea.min.css">
    <link rel="stylesheet" href="~/css/vendor/bootstrap.min.css">

    <!-- CUSTOM -->
    <link rel="stylesheet" href="~/css/custom/main.css">
    <link rel="stylesheet" href="~/css/custom/message.css">
    <!--=====================================
                CSS LINK PART END
    =======================================-->
</head>
<body>
    <!--=====================================
                MESSAGE PART START
    =======================================-->
    <section class="message-part">
        <div class="container">
            <div class="row">
                <!-- Left: User List -->
                <div class="col-lg-4">
                    <div class="message-filter">
                        <input type="text" id="searchUser" class="form-control mb-2" placeholder="Search user...">
                        <ul class="search-suggestions list-group position-absolute" id="suggestionList" style="z-index: 1000;"></ul>
                        <div id="chatList">
                            @Html.Partial("_ChatList", Model)
                        </div>
                    </div>
                </div>

                <!-- Right: Chat Box -->
                <div class="col-lg-8" id="chat-box">
                </div>
            </div>
        </div>
    </section>
    <!--=====================================
                MESSAGE PART END
    =======================================-->
    <!--=====================================
                JS LINK PART START
    =======================================-->
    <!-- VENDOR -->
    <script src="js/vendor/jquery-1.12.4.min.js"></script>
    <script src="js/vendor/popper.min.js"></script>
    <script src="js/vendor/bootstrap.min.js"></script>
    <script src="js/vendor/nice-select.min.js"></script>
    <script src="js/vendor/emojionearea.min.js"></script>
    <script src="js/vendor/nicescroll.min.js"></script>

    <!-- CUSTOM -->
    <script src="js/custom/nice-select.js"></script>
    <script src="js/custom/nicescroll.js"></script>
    <script src="js/custom/emojionearea.js"></script>
    <script src="js/custom/main.js"></script>
    <!--=====================================
                JS LINK PART END
    =======================================-->
    @section Scripts {
        <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.0/signalr.min.js"></script>
        <script>
            var spinnerHtml = '<div class="chat-loading d-flex justify-content-center align-items-center" style="min-height:220px; padding:30px; margin-top:180px">' +
                '<img src="@Url.Content("/images/spinner.gif")" style="height:80px" alt="Loading...">' + '</div>';

            let connection;
            let isConnected = false;

            // Initialize SignalR connection
            function initializeSignalR() {
                connection = new signalR.HubConnectionBuilder()
                    .withUrl("/chatHub")
                    .withAutomaticReconnect()
                    .build();

                connection.on("ReceiveMessage", function (sender, receiver, message) {
                    const myId = '@currentUserId';
                    const activeUser = $("#receiverId").val();

                    const isMine = sender === myId;
                    const shouldDisplay = (activeUser === sender || activeUser === receiver);

                    if (shouldDisplay) {
                        const msgHtml = `
                            <li class="inbox-chat-item ${isMine ? "my-chat" : ""}">
                                <div class="inbox-chat-img">
                                    <img src="${isMine ? window.chatImages.senderImage : window.chatImages.receiverImage}" alt="avatar">
                                </div>
                                <div class="inbox-chat-content">
                                    <div class="inbox-chat-text">
                                        <p>${message}</p>
                                    </div>
                                    <small class="inbox-chat-time">just now</small>
                                </div>
                            </li>`;
                        $("#chatMessageList").append(msgHtml);

                        if (isUserAtBottom) {
                            scrollToBottom();
                        } else {
                            $("#newMsgBtn").show();
                        }
                    }

                    $.ajax({
                        url: '/User/ChatList',
                        type: 'GET',
                        success: function (data) {
                            $('#chatList').html(data);
                        },
                        error: function () {
                            alert('Failed to load list.');
                        }
                    });
                });

                connection.on("UpdateReadCount", function () {
                    $.get('/User/ChatList', function (html) {
                        $('#chatList').html(html);
                    });
                });

                connection.onreconnecting((error) => {
                    console.log("SignalR reconnecting...", error);
                    isConnected = false;
                });

                connection.onreconnected((connectionId) => {
                    console.log("SignalR reconnected with connectionId:", connectionId);
                    isConnected = true;
                });

                connection.onclose((error) => {
                    console.log("SignalR connection closed", error);
                    isConnected = false;
                });

                connection.start()
                    .then(() => {
                        console.log("SignalR connected successfully");
                        isConnected = true;
                    })
                    .catch(err => {
                        console.error("SignalR connection error:", err);
                        isConnected = false;
                        // Retry connection after 5 seconds
                        setTimeout(initializeSignalR, 5000);
                    });
            }

            $(document).ready(function () {
                // Initialize SignalR
                initializeSignalR();

                $("#searchUser").on("keypress", function (event) {
                    const query = $(this).val().trim();
                    if (event.key === "Enter") {
                        $.get('/User/SearchUsers', { term: query }, function (data) {
                            let suggestions = "";
                            data.forEach(u => {
                                suggestions += `
                                    <li class="list-group-item suggestion-item" data-username="${u.username}">
                                        <img src="${u.byteUserImageData ? `data:image/png;base64,${u.byteUserImageData}` : '/images/user.png'}" width="30" height="30" class="rounded-circle me-2" />
                                        ${u.username} - ${u.messageText ?? ''}
                                    </li>`;
                            });
                            $("#suggestionList").html(suggestions).show();
                        });
                    } else {
                        $("#suggestionList").hide().empty();
                    }
                });

                var defaultUserId = '@defaultUser?.userID';
                var currentUsername = '@defaultUser?.username';
                if (defaultUserId) {
                    loadMessages(defaultUserId, currentUsername);
                }
            });

            $(document).on("click", ".suggestion-item", function () {
                const username = $(this).data("username");
                $("#suggestionList").hide().empty();

                if ($('.message-link[data-username="' + username + '"]').length !== 0) {
                    $('.message-link[data-username="' + username + '"]').trigger("click");
                } else {
                    $('#chat-box').html(spinnerHtml);
                    $.get("/User/GetUserChatListItem", { username: username }, function (html) {
                        $(".message-list").prepend(html);

                        $(".message-item").removeClass("active");
                        $('.message-link[data-username="' + username + '"]').closest("li").addClass("active");
                        $('.message-link[data-username="' + username + '"]').trigger("click");
                    });
                }
            });

            function loadMessages(ReceiverUserId, UserName) {
                $('#chat-box').html(spinnerHtml);
                $.ajax({
                    url: '/User/GetMessagesByUser',
                    type: 'GET',
                    data: { ReceiverUserId: ReceiverUserId, username: UserName },
                    success: function (partialViewHtml) {
                        $('#chat-box').html(partialViewHtml);
                    },
                    error: function () {
                        $('#chat-box').html('<div class="alert alert-danger">Failed to load messages.</div>');
                    }
                });
            }

            let isUserAtBottom = true;

            $("#chatMessageList").on("scroll", function () {
                const el = this;
                isUserAtBottom = el.scrollHeight - el.scrollTop - el.clientHeight < 60;
            });

            $("#newMsgBtn").on("click", function () {
                scrollToBottom();
                $(this).hide();
            });

            // Send message
            $(document).on("click", "#sendBtn", function () {
                const message = $("#chat-emoji").val().trim();
                const receiver = $("#receiverId").val();
                const sender = '@currentUserId';

                if (!receiver || !message) {
                    alert("Please select a user and type a message.");
                    return;
                }

                if (!isConnected) {
                    alert("Connection not established. Please wait...");
                    return;
                }

                $.ajax({
                    url: '/User/SendMessage',
                    type: 'GET',
                    data: {
                        senderUserId: sender,
                        receiverUserId: receiver,
                        messageText: message
                    },
                    success: function (response) {
                        if (response && isConnected) {
                            connection.invoke("SendMessage", sender, receiver, message)
                                .catch(err => {
                                    console.error("SignalR send error:", err);
                                    alert("Failed to send message via SignalR");
                                });
                            $("#chat-emoji").val("");
                        }
                    },
                    error: function (xhr) {
                        console.error("Send message error:", xhr);
                        alert("Failed to save message");
                    }
                });
            });

            // Load chat when user clicked
            $(document).on("click", ".message-link", function (e) {
                e.preventDefault();

                const receiverId = $(this).data("receiveruserid");
                const username = $(this).data("username");

                // Mark as read
                //$.post('/User/MarkMessagesAsRead', { senderUserId: receiverId });

                $('#chat-box').html(spinnerHtml);
                $(".message-item").removeClass("active");
                $(this).closest("li").addClass("active");

                loadMessages(receiverId, username);
            });

            const scrollToBottom = () => {
                const list = document.getElementById("chatMessageList");
                if (list) {
                    list.scrollTop = list.scrollHeight;
                }
            };

            function scrollToLastReadMessage() {
                const unread = document.querySelector("#chatMessageList .unread-msg");
                if (unread) {
                    unread.scrollIntoView({
                        behavior: "smooth",
                        block: "center"
                    });
                } else {
                    scrollToBottom();
                }
            }

            setTimeout(scrollToLastReadMessage, 150);
        </script>
    }
</body>
</html>
@model List<UserViewModel>
@{
    ViewBag.Title = "Message";
    int currentUserId = Context.Session.GetInt32("UserId") ?? 0;
    var defaultUser = Model.FirstOrDefault();
}
<!DOCTYPE html>
<html lang="en">
<head>
    <!-- VENDOR -->
    <link rel="stylesheet" href="~/css/vendor/nice-select.min.css">
    <link rel="stylesheet" href="~/css/vendor/emojionearea.min.css">
    <link rel="stylesheet" href="~/css/vendor/bootstrap.min.css">

    <!-- CUSTOM -->
    <link rel="stylesheet" href="~/css/custom/main.css">
    <link rel="stylesheet" href="~/css/custom/message.css">
    <!--=====================================
                CSS LINK PART END
    =======================================-->
</head>
<body>
    <!--=====================================
                MESSAGE PART START
    =======================================-->
    <section class="message-part">
        <div class="container">
            <div class="row">
                <!-- Left: User List -->
                <div class="col-lg-4">
                    <div class="message-filter">
                        <input type="text" id="searchUser" class="form-control mb-2" placeholder="Search user...">
                        <ul class="search-suggestions list-group position-absolute" id="suggestionList" style="z-index: 1000;"></ul>
                        <div id="chatList">
                            @Html.Partial("_ChatList", Model)
                        </div>
                    </div>
                </div>

                <!-- Right: Chat Box -->
                <div class="col-lg-8" id="chat-box">
                </div>
            </div>
        </div>
    </section>
    <!--=====================================
                MESSAGE PART END
    =======================================-->
    <!--=====================================
                JS LINK PART START
    =======================================-->
    <!-- VENDOR -->
    <script src="js/vendor/jquery-1.12.4.min.js"></script>
    <script src="js/vendor/popper.min.js"></script>
    <script src="js/vendor/bootstrap.min.js"></script>
    <script src="js/vendor/nice-select.min.js"></script>
    <script src="js/vendor/emojionearea.min.js"></script>
    <script src="js/vendor/nicescroll.min.js"></script>

    <!-- CUSTOM -->
    <script src="js/custom/nice-select.js"></script>
    <script src="js/custom/nicescroll.js"></script>
    <script src="js/custom/emojionearea.js"></script>
    <script src="js/custom/main.js"></script>
    <!--=====================================
                JS LINK PART END
    =======================================-->
    @section Scripts {
        <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.0/signalr.min.js"></script>
        <script>
            var spinnerHtml =  '<div class="chat-loading d-flex justify-content-center align-items-center" style="min-height:220px; padding:30px; margin-top:180px">' +
            '<img src="@Url.Content("/images/spinner.gif")" style="height:80px" alt="Loading...">' + '</div>';
            $(document).ready(function () {
                $("#searchUser").on("keypress", function (event) {
                    const query = $(this).val().trim();
                    if (event.key === "Enter") {
                        $.get('/User/SearchUsers', { term: query }, function (data) {
                            let suggestions = "";
                            data.forEach(u => {
                                suggestions += `
                                    <li class="list-group-item suggestion-item" data-username="${u.username}">
                                        <img src="${u.byteUserImageData ? `data:image/png;base64,${u.byteUserImageData}` : '/images/user.png'}" width="30" height="30" class="rounded-circle me-2" />
                                        ${u.username} - ${u.messageText ?? ''}
                                    </li>`;
                            });
                            $("#suggestionList").html(suggestions).show();
                        });
                    } else {
                        $("#suggestionList").hide().empty();
                    }
                });
            });

                // $(document).on("click", ".suggestion-item", function () {
                //     const username = $(this).data("username");

                //     //Prevent duplicate users
                //     if ($(`.message-link[data-username='${username}']`).length === 0) {
                //         $.get("/User/GetUserChatListItem", { username: username }, function (html) {
                //             $(".message-list").append(html);
                //         });
                //     }

                //     $("#suggestionList").hide().empty();
                //     $("#searchUser").val('');
                // });
            $(document).on("click", ".suggestion-item", function () {
                const username = $(this).data("username");
                //const userId = $(this).data("user-id");
                $("#suggestionList").hide().empty();
                // Check if the user is already in the sidebar
                if ($('.message-link[data-username="' + username + '"]').length !== 0) {
                    $('.message-link[data-username="' + username + '"]').trigger("click");
                } else {
                    $('#chat-box').html(spinnerHtml);
                    $.get("/User/GetUserChatListItem", { username: username }, function (html) {
                        $(".message-list").prepend(html);

                        // Optionally: load chat messages for that user
                        // $.get("/User/GetMessageByUser/" + userId, function (data) {
                        //     $("#chat-box").html(data);
                        //     $("#receiverId").val(userId);
                        // });

                        // Highlight newly added user
                        $(".message-item").removeClass("active");
                        $('.message-link[data-username="' + username + '"]').closest("li").addClass("active");
                        $('.message-link[data-username="' + username + '"]').trigger("click");
                    });
                }
            });
                    // When a search result is clicked

            function loadMessages(ReceiverUserId, UserName) {
                $('#chat-box').html(spinnerHtml);
                $.ajax({
                    url: '/User/GetMessagesByUser',
                    type: 'GET',
                    data: { ReceiverUserId: ReceiverUserId, username: UserName},
                    success: function (partialViewHtml) {
                        $('#chat-box').html(partialViewHtml);
                        //setTimeout(scrollToBottom, 100); // scroll to bottom after render
                    },
                    error: function () {
                        //alert("Failed to load messages.");
                        $('#chat-box').html('<div class="alert alert-danger">Failed to load messages.</div>');
                    }
                });
            }

            // Optional: Call on page load if you have a default user
            $(document).ready(function () {
                var defaultUserId = '@defaultUser?.userID';
                var currentUsername = '@defaultUser?.username';
                if (defaultUserId) {
                    loadMessages(defaultUserId, currentUsername);
                }
            });
            const connection = new signalR.HubConnectionBuilder()
                .withUrl("/chatHub")
                .build();

            connection.start().then(() => {
                console.log("SignalR connected");

                // Send message
                $(document).on("click", "#sendBtn", function () {
                    const message = $("#chat-emoji").val().trim();
                    const receiver = $("#receiverId").val();
                    const sender = '@currentUserId';

                    if (!receiver || !message) {
                        alert("Please select a user and type a message.");
                        return;
                    }

                    $.ajax({
                        url: '/User/SendMessage',
                        type: 'GET',
                        data: {
                            senderUserId: sender,
                            receiverUserId: receiver,
                            messageText: message
                        },
                        success: function (response) {
                            if (response) {
                                connection.invoke("SendMessage", sender, receiver, message);
                                $("#chat-emoji").val("");
                                setTimeout(scrollToBottom, 100);
                            }
                        }
                    });
                });

                // Receive message live
                connection.on("ReceiveMessage", function (sender, receiver, message) {
                    const myId = '@currentUserId';
                    const activeUser = $("#receiverId").val();

                    const isMine = sender === myId;
                    const shouldDisplay = (activeUser === sender || activeUser === receiver);

                    if (shouldDisplay) {
                        const msgHtml = `
                            <li class="inbox-chat-item ${isMine ? "my-chat" : ""}">
                                <div class="inbox-chat-img">
                                    <img src="${isMine ? window.chatImages.senderImage : window.chatImages.receiverImage}" alt="avatar">
                                </div>
                                <div class="inbox-chat-content">
                                    <div class="inbox-chat-text">
                                        <p>${message}</p>
                                    </div>
                                    <small class="inbox-chat-time">just now</small>
                                </div>
                            </li>`;
                        $("#chatMessageList").append(msgHtml);
                        setTimeout(scrollToBottom, 100);
                    }

                    $.ajax({
                        url: '/User/ChatList',
                        type: 'GET',
                        success: function (data) {
                            $('#chatList').html(data);
                        },
                        error: function () {
                            alert('Failed to load list.');
                        }
                    });
                });
            });

                // Load chat when user clicked
                $(document).on("click", ".message-link", function (e) {
                    e.preventDefault();
                    //const SenderUserId = $(this).data("senderuserid");
                    const ReceiverUserId = $(this).data("receiveruserid");
                    const username = $(this).data("username");
                    //$("#receiverId").val(userId);

                    $('#chat-box').html(spinnerHtml);
                    $(".message-item").removeClass("active");
                    $(this).closest("li").addClass("active");

                    $.ajax({
                        url: '/User/GetMessagesByUser',
                        type: 'GET',
                        data: { ReceiverUserId: ReceiverUserId, username: username },
                        success: function (data) {
                            $("#chat-box").html(data);
                            setTimeout(scrollToBottom, 100);
                        },
                        error: function () {
                            $("#chat-box").html('<div class="alert alert-danger">Failed to load messages.</div>');
                        }
                    });
                });
                const scrollToBottom = () => {
                    const list = document.getElementById("chatMessageList");
                    if (list) {
                        list.scrollTop = list.scrollHeight;
                    }
                };
        </script>
    }
</body>
</html>
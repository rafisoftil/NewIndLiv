@model IEnumerable<ProductViewModel>
@using NonFactors.Mvc.Grid;
@{
    ViewBag.Title = "Manage Ads";
}
<!--=====================================
SINGLE BANNER PART START
=======================================-->
<section class="single-banner">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div class="single-content">
                    <h2>Manage Ads List</h2>
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a asp-controller="Dashboard" asp-action="Dashboard">Home</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Manage Ads</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
</section>
<!--=====================================
SINGLE BANNER PART END
=======================================-->
<br />
<div class="container">

    <div class="container-fluid">
        @(
            Html.Grid(Model).Build(col =>
                {
                col.Add().RenderedAs((model, row) => row + 1).Titled("#");
                    col.Add(Model => Model.productName).Titled("Product");
                col.Add(Model => Model.productCategoryName).Titled("Category");
                col.Add(Model => $"${Model.productPrice}").Titled("Price");
                col.Add(Model => Model.productPriceCondition).Titled("Type");
                col.Add(Model => Model.productOwnerName).Titled("Owner");
                col.Add(Model => Model.createdDate).Titled("Created Date");
                col.Add(Model => Model.IsActiveStatus).Titled("Status");
                col.Add()
                .Titled("Action")
                .Encoded(false)
                .RenderedAs(Model => $@"
        <a href='#' title='View Details' class='icon fas fa-eye'
        data-toggle='modal' data-target='#productDetailsModal'
        onclick='populateModal({System.Text.Json.JsonSerializer.Serialize(Model)})'>
        </a>");   
            })
            .Sortable().Filterable()
            .Empty("No data Found")
            .Pageable(pager =>
            {
                pager.PageSizes = new Dictionary<Int32, String> { { 0, "All" }, { 5, "5" }, { 10, "10" }, { 50, "50" } };
                pager.ShowPageSizes = false;
                pager.PagesToDisplay = 3;
                @* pager.CurrentPage = 1; *@
                pager.RowsPerPage = 10;
            })
            )
    </div>
</div>
<div class="modal fade" id="productDetailsModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLongTitle" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLongTitle" style="color:#06038d">Product Details</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            </div>
            <div class="modal-body d-flex">
                <!-- Left Column: Image and Description -->
                <div class="w-50 pr-4">
                    <div class="common-card text-center">
                        <img id="image-modal" src="" alt="Image not available" class="img-fluid rounded">
                    </div>
                    <div class="common-card mt-4">
                        <div class="card-header">
                            <h5 class="card-title">Description</h5>
                        </div>
                        <p id="productDescription-modal" class="ad-details-desc"></p>
                    </div>
                </div>
                <!-- Right Column: Specifications -->
                <div class="w-50">
                    <div class="common-card">
                        <div class="card-header">
                            <h5 class="card-title">Specification</h5>
                        </div>
                        <p id="productId-modal" data-product-id="" style="display:none"></p>
                        <ul class="ad-details-specific">
                            <li class="d-flex justify-content-between">
                                <h6>Product Name:</h6>
                                <p id="productName-modal"></p>
                            </li>
                            <li class="d-flex justify-content-between">
                                <h6>Price:</h6>
                                <p id="productPrice-modal"></p>
                            </li>
                            <li class="d-flex justify-content-between">
                                <h6>Quantity:</h6>
                                <p id="productQuantity-modal"></p>
                            </li>
                            <li class="d-flex justify-content-between">
                                <h6>Published:</h6>
                                <p id="productPublished-modal"></p>
                            </li>
                            <li class="d-flex justify-content-between">
                                <h6>Category:</h6>
                                <p id="productCategory-modal"></p>
                            </li>
                            <li class="d-flex justify-content-between">
                                <h6>Created By:</h6>
                                <p id="productOwner-modal"></p>
                            </li>
                            <li class="d-flex justify-content-between">
                                <h6>Ad Status:</h6>
                                <p id="productStatus-modal" data-product-status=""></p>
                            </li>
                            <li>
                                <h6>Review Status:</h6>
                                <label>
                                    <input type="radio" id="statusApproved" name="status" value="true" /> Approved
                                </label>
                                <label>
                                    <input type="radio" id="statusRejected" name="status" value="false" /> Rejected
                                </label>
                                <label>
                                    <input type="radio" id="statusInReview" name="status" value="false" /> InReview
                                </label>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="submit" class="btn btn-inline" form="productDetailsForm" onclick="updateReview()" data-dismiss="modal">Change Status</button>
            </div>
        </div>
    </div>
</div>
<div id="spinner" class="d-none">
    <img style="height: 100px" src="~/images/spinner.gif" />
</div>
<div id="toast" class="d-none"></div>

<script src="~/js/mvc-grid/mvc-grid.js"></script>
<script>
    document.querySelectorAll(".mvc-grid").forEach(element => new MvcGrid(element));
    function Edit(userId){
        //alert(userId);
    }

    function populateModal(product) {

        if (typeof product === "string") {
        product = JSON.parse(product);
        }

        var myModal = new bootstrap.Modal(document.getElementById('productDetailsModal'));
        myModal.show();

        var image = $('#image-modal');
        var status = product.IsActiveStatus;
        var reviewStatus = product.productAdminReviewStatus;

        $('#productId-modal').attr('data-product-id', product.productId);
        $('#productName-modal').text(product.productName);
        $('#productCategory-modal').text(product.productCategoryName);
        $('#productQuantity-modal').text(product.productQuantity);
        $('#productPrice-modal').text(`$${product.productPrice}`);
        $('#productOwner-modal').text(product.createdBy);
        $('#productDescription-modal').text(product.productDescription);
        $('#productPublished-modal').text(product.createdDate);
        $('#productStatus-modal').text(status).attr('data-product-status', status);

        if (reviewStatus == "AD Approved") {
            $('#statusApproved').prop('checked', true).prop('disabled', true);
        }
        else if (reviewStatus == "AD Rejected") {
            $('#statusRejected').prop('checked', true).prop('disabled', true);
        }
        else {
            $('#statusInReview').prop('checked', true);
        }
        $('#statusInReview').prop('disabled', true);
        image.attr("src", "/images/spinner.gif");
        image.height("20px");
        var productId = product.productId;
        $.ajax({
            url: '/Dashboard/GetImageDetails',
            type: 'GET',
            data: { productid: productId },
            success: function (response) {
                if (response.image) {
                    console.log(response.image);
                    image.attr("src", "data:image/jpeg;base64," + response.image); // Set image to base64
                    image.height("200px");
                } else {
                    image.attr("src", "/images/no-image.png"); // Fallback if no image found
                    image.height("200px");
                }
            },
            error: function () {
                image.attr("src", "/images/no-image.png"); // Fallback if API call fails
            }
        });
    }

    function updateReview() {
        var productId = $('#productId-modal').attr('data-product-id');
        const status = document.querySelector('input[name="status"]:checked').value;
        const spinner = document.getElementById('spinner');

        const toast = $('#toast');
        spinner.classList.remove('d-none');
        $.ajax({
            url: '/Dashboard/UpdateAdAdminReview',
            type: 'POST',
            data: { productid: productId, status: status },
            success: function (response) {
                spinner.classList.add('d-none');
                toast.addClass('toast_success');
                location.reload();
                toast.text(response.message);
                toast.removeClass('d-none');
                setTimeout(() => {
                    toast.addClass('d-none');
                }, 3000);
            },
            error: function () {
                toast.addClass('toast_failed');
                toast.text('Something went wrong! Please try again.');
            }
        });
    }
</script>
@model AdListFiltersViewModel
@{
    ViewBag.Title = "Ads List";
}
<style>
    .accordion {
        /* background-color: #eee; */
        color: #444;
        cursor: pointer;
        padding: 18px;
        width: 100%;
        text-align: left;
        border: none;
        outline: none;
        transition: 0.4s;
    }

        /* Add a background color to the button if it is clicked on (add the .active class with JS), and when you move the mouse over it (hover) */
        /* .active, .accordion:hover {
            background-color: #ccc;
        } */

    /* Style the accordion panel. Note: hidden by default */
    .panel {
        padding: 0 18px;
        background-color: white;
        display: none;
        overflow: hidden;
    }
</style>
<!--=====================================
                      SINGLE BANNER PART START
            =======================================-->
<section class="inner-section single-banner">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div class="single-content">
                    <h2>ad list</h2>
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a asp-action="Dashboard" asp-controller="Dashboard">Home</a></li>
                        <li class="breadcrumb-item active" aria-current="page">ad-list</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
</section>
<!--=====================================
          SINGLE BANNER PART END
=======================================-->
<!--=====================================
                    AD LIST PART START
        =======================================-->
<section class="inner-section ad-list-part">
    <div class="container">
        <div class="row content-reverse">
            <div class="col-lg-4 col-xl-3">
                <div class="row">
                    <div class="col-md-6 col-lg-12">
                        <div class="product-widget">
                            <div class="row align-items-center justify-content-between mb-2 accordion">
                                <h6 class="product-widget-title">Filter by Price</h6>
                               @*  <div class="col-6">
                                    <h6 class="product-widget-title">Filter by Price</h6>
                                </div>
                                <div class="col-6 text-end">
                                    <label class="filter-label mb-1">Sort by:</label>
                                    <select class="form-select form-select-sm w-auto d-inline-block" onchange="sortByPrice(this.value)">
                                        <option value="" selected>Sort</option>
                                        <option value="asc">Min-Max</option>
                                        <option value="desc">Max-Min</option>
                                    </select>
                                </div> *@
                            </div>

                            <form class="product-widget-form" asp-controller="Dashboard" asp-action="productsList" method="get">
                                <div class="product-widget-group">
                                    <label class="filter-label mb-1">Sort by:</label>
                                    <select class="form-select form-select-sm w-auto d-inline-block" onchange="sortByPrice(this.value)">
                                        <option value="" selected>Sort</option>
                                        <option value="asc">Min-Max</option>
                                        <option value="desc">Max-Min</option>
                                    </select>
                                </div>
                                <div class="product-widget-group">
                                    <input type="number" id="decMinPrice" placeholder="min - 00" min="0" max="10000000" oninput="if (this.value>10000000) this.value=10000000;">
                                    <input type="number" id="decMaxPrice" placeholder="max - 1B" min="0" max="10000000" oninput="if (this.value>10000000) this.value=10000000;">
                                </div>
                                <button type="button" class="product-widget-btn" onclick="updatePriceRange()">
                                    <i class="fas fa-search"></i>
                                    <span>search</span>
                                </button>
                                <br />
                                <button type="button" class="product-widget-btn" onclick="updatePriceRange(null)">
                                    <i class="fas fa-broom"></i>
                                    <span>Clear Filter</span>
                                </button>
                            </form>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-12">
                        <div class="product-widget">
                            <h6 class="product-widget-title accordion">Filter by type</h6>
                            <form class="product-widget-form">
                                <ul class="product-widget-list">
                                    <li class="product-widget-item">
                                        <div class="product-widget-checkbox"><input type="checkbox" class="filter-type" onchange="updateAdType('sale', this.checked)" id="filtersale"></div>
                                        <label class="product-widget-label" for="chcek1">
                                            <span class="product-widget-type sale">sales</span>
                                            <span class="product-widget-number">(@Model.Filters[0].totalCount)</span>
                                        </label>
                                    </li>
                                    <li class="product-widget-item">
                                        <div class="product-widget-checkbox"><input type="checkbox" class="filter-type" onchange="updateAdType('rent', this.checked)" id="filterrent"></div>
                                        <label class="product-widget-label" for="chcek2">
                                            <span class="product-widget-type rent">rental</span>
                                            <span class="product-widget-number">(@Model.Filters[1].totalCount)</span>
                                        </label>
                                    </li>
                                    <li class="product-widget-item">
                                        <div class="product-widget-checkbox"><input type="checkbox" class="filter-type" onchange="updateAdType('booking', this.checked)" id="filterbooking"></div>
                                        <label class="product-widget-label" for="chcek3">
                                            <span class="product-widget-type booking">booking</span>
                                            <span class="product-widget-number">(@Model.Filters[2].totalCount)</span>
                                        </label>
                                    </li>
                                </ul>
                                <button type="button" class="product-widget-btn" onclick="updateAdType('clear', false)">
                                    <i class="fas fa-broom"></i>
                                    <span>Clear Filter</span>
                                </button>
                            </form>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-12">
                        <div class="product-widget">
                            <h6 class="product-widget-title accordion">Filter by rating</h6>
                            <form class="product-widget-form">
                                <ul class="product-widget-list">
                                    <li class="product-widget-item">
                                        <div class="product-widget-checkbox">
                                            <input type="checkbox" id="rating5" class="rating-filter" onchange="updateRating(5, this.checked)">
                                        </div>
                                        <label class="product-widget-label" for="rating5">
                                            <span class="product-widget-star">
                                                <i class="fas fa-star"></i>
                                                <i class="fas fa-star"></i>
                                                <i class="fas fa-star"></i>
                                                <i class="fas fa-star"></i>
                                                <i class="fas fa-star"></i>
                                            </span>
                                            @* <span class="product-widget-number">(45)</span> *@
                                        </label>
                                    </li>
                                    <li class="product-widget-item">
                                        <div class="product-widget-checkbox">
                                            <input type="checkbox" id="rating4" class="rating-filter" onchange="updateRating(4, this.checked)">
                                        </div>
                                        <label class="product-widget-label" for="rating4">
                                            <span class="product-widget-star">
                                                <i class="fas fa-star"></i>
                                                <i class="fas fa-star"></i>
                                                <i class="fas fa-star"></i>
                                                <i class="fas fa-star"></i>
                                                <i class="far fa-star"></i>
                                            </span>
                                            <span class="product-widget-number">(55)</span>
                                        </label>
                                    </li>
                                    <li class="product-widget-item">
                                        <div class="product-widget-checkbox">
                                            <input type="checkbox" id="rating3" class="rating-filter" onchange="updateRating(3, this.checked)">
                                        </div>
                                        <label class="product-widget-label" for="rating3">
                                            <span class="product-widget-star">
                                                <i class="fas fa-star"></i>
                                                <i class="fas fa-star"></i>
                                                <i class="fas fa-star"></i>
                                                <i class="far fa-star"></i>
                                                <i class="far fa-star"></i>
                                            </span>
                                            <span class="product-widget-number">(65)</span>
                                        </label>
                                    </li>
                                    <li class="product-widget-item">
                                        <div class="product-widget-checkbox">
                                            <input type="checkbox" id="rating2" class="rating-filter" onchange="updateRating(2, this.checked)">
                                        </div>
                                        <label class="product-widget-label" for="rating2">
                                            <span class="product-widget-star">
                                                <i class="fas fa-star"></i>
                                                <i class="fas fa-star"></i>
                                                <i class="far fa-star"></i>
                                                <i class="far fa-star"></i>
                                                <i class="far fa-star"></i>
                                            </span>
                                            <span class="product-widget-number">(75)</span>
                                        </label>
                                    </li>
                                    <li class="product-widget-item">
                                        <div class="product-widget-checkbox">
                                            <input type="checkbox" id="rating1" class="rating-filter" onchange="updateRating(1, this.checked)">
                                        </div>
                                        <label class="product-widget-label" for="rating1">
                                            <span class="product-widget-star">
                                                <i class="fas fa-star"></i>
                                                <i class="far fa-star"></i>
                                                <i class="far fa-star"></i>
                                                <i class="far fa-star"></i>
                                                <i class="far fa-star"></i>
                                            </span>
                                            <span class="product-widget-number">(85)</span>
                                        </label>
                                    </li>
                                </ul>
                                <button type="submit" class="product-widget-btn" onclick="updateRating('clear')">
                                    <i class="fas fa-broom"></i>
                                    <span>Clear Filter</span>
                                </button>
                            </form>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-12">
                        <div class="product-widget">
                            <h6 class="product-widget-title accordion">Filter by Cities</h6>
                            <form class="product-widget-form">
                                <div class="product-widget-search">
                                    <input type="text" id="citySearchInput" onkeyup="filterCities()" placeholder="Search">
                                </div>
                                <ul class="product-widget-list product-widget-scroll">
                                    @foreach (var item in Model.Filters)
                                    {
                                        if (@item.CategoryType == "Cities")
                                        {
                                            <li class="product-widget-item city-item">
                                                <div class="product-widget-checkbox">
                                                    <input type="checkbox" class="city-filter-checkbox" id="city_@item.CategoryValue" onchange="updateCity('@item.CategoryValue', this.checked)">
                                                </div>
                                                <label class="product-widget-label" for="check_@item.CategoryValue">
                                                    <span class="product-widget-text city-text">@item.CategoryValue</span>
                                                    <span class="product-widget-number">(@item.totalCount)</span>
                                                </label>
                                            </li>
                                        }
                                    }
                                </ul>
                                <button type="button" id="clearCityFilterBtn" class="product-widget-btn" onclick="updateCity('clear', false)">
                                    <i class="fas fa-broom"></i>
                                    <span>Clear Filter</span>
                                </button>
                            </form>
                        </div>
                    </div>
                    @* <div class="col-md-6 col-lg-12">
                        <div class="product-widget">
                            <h6 class="product-widget-title">Filter by popularity</h6>
                            <form class="product-widget-form">
                                <div class="product-widget-search">
                                    <input type="text" placeholder="Search">
                                </div>
                                <ul class="product-widget-list product-widget-scroll">
                                    <li class="product-widget-item">
                                        <div class="product-widget-checkbox">
                                            <input type="checkbox" id="chcek9">
                                        </div>
                                        <label class="product-widget-label" for="chcek9">
                                            <span class="product-widget-text">laptop</span>
                                            <span class="product-widget-number">(68)</span>
                                        </label>
                                    </li>
                                    <li class="product-widget-item">
                                        <div class="product-widget-checkbox">
                                            <input type="checkbox" id="chcek10">
                                        </div>
                                        <label class="product-widget-label" for="chcek10">
                                            <span class="product-widget-text">camera</span>
                                            <span class="product-widget-number">(78)</span>
                                        </label>
                                    </li>
                                    <li class="product-widget-item">
                                        <div class="product-widget-checkbox">
                                            <input type="checkbox" id="chcek11">
                                        </div>
                                        <label class="product-widget-label" for="chcek11">
                                            <span class="product-widget-text">television</span>
                                            <span class="product-widget-number">(34)</span>
                                        </label>
                                    </li>
                                    <li class="product-widget-item">
                                        <div class="product-widget-checkbox">
                                            <input type="checkbox" id="chcek12">
                                        </div>
                                        <label class="product-widget-label" for="chcek12">
                                            <span class="product-widget-text">by cycle</span>
                                            <span class="product-widget-number">(43)</span>
                                        </label>
                                    </li>
                                    <li class="product-widget-item">
                                        <div class="product-widget-checkbox">
                                            <input type="checkbox" id="chcek13">
                                        </div>
                                        <label class="product-widget-label" for="chcek13">
                                            <span class="product-widget-text">bike</span>
                                            <span class="product-widget-number">(57)</span>
                                        </label>
                                    </li>
                                    <li class="product-widget-item">
                                        <div class="product-widget-checkbox">
                                            <input type="checkbox" id="chcek14">
                                        </div>
                                        <label class="product-widget-label" for="chcek14">
                                            <span class="product-widget-text">private car</span>
                                            <span class="product-widget-number">(67)</span>
                                        </label>
                                    </li>
                                    <li class="product-widget-item">
                                        <div class="product-widget-checkbox">
                                            <input type="checkbox" id="chcek15">
                                        </div>
                                        <label class="product-widget-label" for="chcek15">
                                            <span class="product-widget-text">air condition</span>
                                            <span class="product-widget-number">(98)</span>
                                        </label>
                                    </li>
                                    <li class="product-widget-item">
                                        <div class="product-widget-checkbox">
                                            <input type="checkbox" id="chcek16">
                                        </div>
                                        <label class="product-widget-label" for="chcek16">
                                            <span class="product-widget-text">apartment</span>
                                            <span class="product-widget-number">(45)</span>
                                        </label>
                                    </li>
                                    <li class="product-widget-item">
                                        <div class="product-widget-checkbox">
                                            <input type="checkbox" id="chcek17">
                                        </div>
                                        <label class="product-widget-label" for="chcek17">
                                            <span class="product-widget-text">watch</span>
                                            <span class="product-widget-number">(76)</span>
                                        </label>
                                    </li>
                                </ul>
                                <button type="submit" class="product-widget-btn">
                                    <i class="fas fa-broom"></i>
                                    <span>Clear Filter</span>
                                </button>
                            </form>
                        </div>
                    </div> *@
                    <div class="col-md-6 col-lg-12">
                        <div class="product-widget">
                            <h6 class="product-widget-title accordion">filter by category</h6>
                            <form class="product-widget-form">
                                <div class="product-widget-search">
                                    <input type="text" placeholder="search" id="categorySearch" onkeyup="filterCategories()">
                                </div>
                                <ul class="product-widget-list product-widget-scroll">
                                    @foreach (var item in Model.Categories)
                                    {
                                        <li class="product-widget-dropitem category-item">
                                            <button type="button" class="product-widget-link" onclick="updateCategory('@item.CategoryID')">
                                                <i class="fas fa-tags"></i>
                                                @item.CategoryName (@item.CategoryCount)
                                            </button>
                                            <ul class="product-widget-dropdown">
                                                @foreach (var subCat in item.subCategories)
                                                {
                                                    <li><a class="product-subcategory" onclick="updateSubCategory('@subCat.subCategoryID', '@item.CategoryID')">@subCat.subCatergoryName (@subCat.intSubCategoryCount)</a></li>
                                                }
                                            </ul>
                                        </li>
                                    }
                                </ul>
                                <button type="button" class="product-widget-btn" onclick="updateCategory('0')">
                                    <i class="fas fa-broom"></i>
                                    <span>Clear Filter</span>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-8 col-xl-9">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="header-filter">
                            <div class="filter-show">
                                <label class="filter-label">Show :</label>
                                <select id="itemsPerPageSelect" class="custom-select filter-select">
                                    <option value="12">12</option>
                                    <option value="24">24</option>
                                    <option value="36">36</option>
                                </select>
                            </div>
                            @* <div class="filter-short">
                                <label class="filter-label">Sort by :</label>
                                <select class="custom-select filter-select" onchange="sortByPrice(this.value)">
                                    <option selected>default</option>
                                    <option value="4">Price(min-max)</option>
                                    <option value="5">Price(max-min)</option>
                                    <option value="3">trending</option>
                                    <option value="1">featured</option>
                                    <option value="2">recommend</option>
                                </select>
                            </div> *@
                            <div class="filter-action">
                                <a onclick="changeGridView()" id="grid1" title="Three Column" class="active"><i class="fas fa-th"></i></a>
                                <a onclick="changeGridView2()" id="grid2" title="Two Column"><i class="fas fa-th-large"></i></a>
                                <a onclick="changeGridView3()" id="grid3" title="One Column"><i class="fas fa-th-list"></i></a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-lg-12">
                        <div class="ad-feature-slider slider-arrow">
                            @foreach (var product in Model.RecommendedAds)
                            {
                                <div class="feature-card">
                                    <a href="#" class="feature-img">
                                        <img src="data:image/png;base64,@Convert.ToBase64String(product.byteProductImageData)" onerror="this.onerror=null; this.src='/images/no-image.png';" alt="feature" width="565" height="401" />
                                    </a>
                                    <div class="cross-inline-badge feature-badge">
                                        <span>featured</span>
                                        <i class="fas fa-book-open"></i>
                                    </div>
                                    <button type="button" class="feature-wish">
                                        <i class="fas fa-heart"></i>
                                    </button>
                                    <div class="feature-content">
                                        <ol class="breadcrumb feature-category">
                                            <li><span class="flat-badge @(product.productAdCategory.ToLower())">@product.productAdCategory</span></li>
                                            <li class="breadcrumb-item"><a href="#">@product.productCategoryName</a></li>
                                            <li class="breadcrumb-item active" aria-current="page">@product.productSubCategoryName</li>
                                        </ol>
                                        <h3 class="feature-title"><a href="ad-details-left.html">@product.productDescription</a></h3>
                                        <div class="feature-meta">
                                            <span class="feature-price">₹@product.productPrice.ToString("F2")<small>/@product.productPriceCondition</small></span>
                                            <span class="feature-time"><i class="fas fa-clock"></i>@product.updatedDate.ToString("MMM dd, h:mm tt")</span>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
                <div class="row" id="divPartial">
                    @Html.Partial("_ProductsPartial", Model.Products)
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="productDetailsModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLongTitle" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLongTitle" style="color:#06038d">Product Details</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                </div>
                <div class="modal-body d-flex">
                    <!-- Left Column: Image and Description -->
                    <div class="w-50 pr-4">
                        <div class="comm on-card text-center">
                            <img id="image-modal" src="" style="height: 200px" alt="Image not available" class="img-fluid rounded">
                        </div>
                        <div class="common-card mt-4">
                            <div class="card-header">
                                <h5 class="card-title">Description</h5>
                            </div>
                            <p id="productDescription-modal" class="ad-details-desc"></p>
                        </div>
                    </div>
                    <!-- Right Column: Specifications -->
                    <div class="w-50">
                        <div class="common-card">
                            <div class="card-header">
                                <h5 class="card-title">Specification</h5>
                            </div>
                            <p id="productId-modal" data-product-id="" style="display:none"></p>
                            <ul class="ad-details-specific">
                                <li class="d-flex justify-content-between">
                                    <h6>Product Name:</h6>
                                    <p id="productName-modal"></p>
                                </li>
                                <li class="d-flex justify-content-between">
                                    <h6>Price:</h6>
                                    <p id="productPrice-modal"></p>
                                </li>
                                <li class="d-flex justify-content-between">
                                    <h6>Quantity:</h6>
                                    <p id="productQuantity-modal"></p>
                                </li>
                                <li class="d-flex justify-content-between">
                                    <h6>Published at:</h6>
                                    <p id="productPublished-modal"></p>
                                </li>
                                <li class="d-flex justify-content-between">
                                    <h6>Category:</h6>
                                    <p id="productCategory-modal"></p>
                                </li>
                                <li class="d-flex justify-content-between">
                                    <h6>Created By:</h6>
                                    <p id="productOwner-modal"></p>
                                </li>
                                @* <li class="d-flex justify-content-between">
                                <h6>Ad Status:</h6>
                                <p id="productStatus-modal" data-product-status=""></p>
                            </li> *@
                            </ul>
                        </div>
                        @{
                            var isUserLoggedIn = !string.IsNullOrEmpty(Context.Session.GetString("userName"));
                        }
                        @* <div class="@(isUserLoggedIn ? "" : "d-none")">
                        <div class="card-header">
                            <h5 class="card-title">Submit your Rating</h5>
                        </div>
                        <div id="starRating" class="star-rating" data-selected="0">
                            <span class="fa fa-star rating-size" data-value="5" onclick="selectRating(this)"></span>
                            <span class="fa fa-star rating-size" data-value="4" onclick="selectRating(this)"></span>
                            <span class="fa fa-star rating-size" data-value="3" onclick="selectRating(this)"></span>
                            <span class="fa fa-star rating-size" data-value="2" onclick="selectRating(this)"></span>
                            <span class="fa fa-star rating-size" data-value="1" onclick="selectRating(this)"></span>
                        </div>
                        <input type="hidden" id="selectedRating" name="Rating" value="0" />
                    </div> *@
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</section>
<!--=====================================
            AD LIST PART END
=======================================-->
<!--=====================================
          CURRENCY MODAL PART START
=======================================-->
<div class="modal fade" id="currency">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h4>Choose a Currency</h4>
                <button class="fas fa-times" data-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <button class="modal-link active">United States Doller (USD) - $</button>
                <button class="modal-link">Euro (EUR) - €</button>
                <button class="modal-link">British Pound (GBP) - £</button>
                <button class="modal-link">Australian Dollar (AUD) - A$</button>
                <button class="modal-link">Canadian Dollar (CAD) - C$</button>
            </div>
        </div>
    </div>
</div>
<!--=====================================
          CURRENCY MODAL PART END
=======================================-->
<!--=====================================
          LANGUAGE MODAL PART END
=======================================-->
<div class="modal fade" id="language">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h4>Choose a Language</h4>
                <button class="fas fa-times" data-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <button class="modal-link active">English</button>
                <button class="modal-link">bangali</button>
                <button class="modal-link">arabic</button>
                <button class="modal-link">germany</button>
                <button class="modal-link">spanish</button>
            </div>
        </div>
    </div>
</div>
<!--=====================================
           LANGUAGE MODAL PART END
=======================================-->

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script type="text/javascript">
    function AddToWishlist(button, productID, createdBy) {
        const loggedUserId = '@Context.Session.GetInt32("UserId")';

        if (!loggedUserId || loggedUserId === "null") {
            window.location.href = "/Dashboard/Login";
            return;
        }

        var isInWishlist = button.classList.contains("fas");

        $.ajax({
            url: '/User/UpdateBookmarks',
            type: 'POST',
            data: { productID: productID, createdBy: createdBy, status: isInWishlist ? 0 : 1 },
            success: function (response) {
                if (response.statusCode != 200) {
                    alert('Error in processing request.');
                }
                else {
                    UpdateWishlistCount();
                }
            },
            error: function () {
                alert('Error in processing request.');
            }
        });
    }

    function UpdateWishlistCount() {
        $.ajax({
            url: '/User/GetWishlistCount',
            type: 'GET',
            success: function (response) {
                $('.wishlist-count').text(response.count);
            }
        });
    }


    var itemsPerPage = 12;
    var selectedCities = [];
    var selectedAdTypes = [];
    var selectedRatings = [];
    let categoryId = 0;
    let subCategoryId = 0;
    var minPrice = null;
    var maxPrice = null;
    var sort = "";
    var isFeatured = false;
    var isTrending = false;
    var isRecommended = false;
    
    $('#itemsPerPageSelect').on('change', function () {
        itemsPerPage = $(this).val();
        changePage();
    });

    function updatePriceRange(type) {
        minPrice = parseFloat($('#decMinPrice').val());
        maxPrice = parseFloat($('#decMaxPrice').val());

        if (type === null) {
            minPrice = null;
            maxPrice = null;
            $('#decMinPrice').val('');
            $('#decMaxPrice').val('');
            //$('.form-select').val("0");
        }
        updateAdList();
    }
    function updateRating(rating, isChecked) {
        if (rating === 'clear') {
            selectedRatings = [];
            document.querySelectorAll('.rating-filter').forEach(btn => {
                btn.checked = false;
            });
        }
        else if (isChecked) {
            selectedRatings.push(rating);
        } else {
            selectedRatings = selectedRatings.filter(r => r !== rating);
        }
        updateAdList();
    }

    function updateAdList() {
        var strCity = selectedCities.join(',');
        var adtype = selectedAdTypes.join(',');
        var ratings = selectedRatings.join(',');
        var categoryid = categoryId;
        var subcategoryid = subCategoryId;
        var decMinPrice = parseFloat($('#decMinPrice').val());
        var decMaxPrice = parseFloat($('#decMaxPrice').val());
        $('#divPartial').html('<div style="text-align:center; margin-top:500px;"><img src="/images/Hourglass.gif" /></div>');
        $.ajax({
          url: '/Dashboard/ProductList',
          type: 'GET',
          data: {decMinPrice: decMinPrice, decMaxPrice: decMaxPrice, adtype: adtype, strCity: strCity, categoryid: categoryid, subcategoryid: subcategoryid, ratings: ratings, sort: sort, itemsPerPage: itemsPerPage, featured: isFeatured, recommended: isRecommended, trend: isTrending},
          contentType: 'application/json',
          success: function (data) {
            $('#divPartial').html(data); // Load updated product list
          }
        });
    }

    function updateCategory(cat)
    {
        categoryId = cat;
        subCategoryId = 0;
        updateAdList();
    }

    function updateSubCategory(subcat, cat) {
        subCategoryId = subcat;
        categoryId = cat;
        updateAdList();
    }

    function updateCity(city, isChecked) {
        if (city === 'clear') {
            selectedCities = [];
            document.querySelectorAll('.city-filter-checkbox').forEach(btn => {
                btn.checked = false;
            });
        }
        else if (isChecked) {
            selectedCities.push(city.toLowerCase());
        } else {
            selectedCities = selectedCities.filter(c => c !== city.toLowerCase());
        }
        updateAdList();
    }
    function updateAdType(type, isChecked) {
        if (type === 'clear') {
            document.querySelectorAll('.filter-type').forEach(btn => {
                 btn.checked = false;
             });
            selectedAdTypes = [];
        }
        else if (isChecked) {
            selectedAdTypes.push(type.toLowerCase());
        } else {
            selectedAdTypes = selectedAdTypes.filter(t => t !== type.toLowerCase());
        }
        updateAdList();
    }

    function sortByPrice(type) {
        sort = type;
        updateAdList();
    }

    $(document).ready(function () {
        // Get the city parameter from URL
        const urlParams = new URLSearchParams(window.location.search);
        const cityParam = urlParams.get('strCity');
        categoryId = urlParams.get('categoryid');
        subCategoryId = urlParams.get('subcategoryid');
        isFeatured = urlParams.get('featured') === 'true' || urlParams.get('featured') === 'True';
        isTrending = urlParams.get('trend') === 'true' || urlParams.get('trend') === 'True';
        isRecommended = urlParams.get('recommended') === 'true' || urlParams.get('recommended') === 'True';
        
        console.log(categoryId);
        console.log(subCategoryId);
        console.log('isFeatured:', isFeatured);
        console.log('isTrending:', isTrending);
      
        if (cityParam) {
            // Find and check the corresponding checkbox
            const cityCheckbox = document.querySelector(`#city_${cityParam}`);
            if (cityCheckbox) {
                cityCheckbox.checked = true;
                // Update the selected cities array and trigger filter
                updateCity(cityParam, true);
            }
        }

        // Ad Type Checkbox
        $('.filter-type').on('change', function () {
            var type = $(this).val();
            updateAdType(type, $(this).is(':checked'));
        });

        // Category Checkbox
        $('.filter-category').on('change', function () {
            var catId = $(this).val();
            updateCategory(catId, $(this).is(':checked'));
        });

        // City Checkbox
        $('.filter-city').on('change', function () {
            var city = $(this).val();
            updateCity(city, $(this).is(':checked'));
        });

        // Price Range
        $('#priceFilterButton').on('click', function () {
            updatePriceRange();
        });
    });

    function filterCities() {
        const input = document.getElementById("citySearchInput");
        const filter = input.value.toLowerCase();
        const items = document.querySelectorAll(".city-item");

        items.forEach(item => {
            const cityName = item.querySelector(".city-text").textContent.toLowerCase();
            if (cityName.includes(filter)) {
                item.style.display = "";
            } else {
                item.style.display = "none";
            }
        });
    }

    function filterCategories() {
        const input = document.getElementById('categorySearch');
        const filter = input.value.toLowerCase();
        const categoryItems = document.querySelectorAll('.category-item');

        categoryItems.forEach(function (item) {
            const categoryText = item.querySelector('.product-widget-link').innerText.toLowerCase();
            const subDropdown = item.querySelector('.product-widget-dropdown');
            const subcategories = subDropdown.querySelectorAll('.product-subcategory');

            let categoryMatch = categoryText.includes(filter);
            let subcategoryMatch = false;

            // Always reset subcategory visibility
            subcategories.forEach(sub => sub.parentElement.style.display = '');

            if (filter === '') {
                item.style.display = '';
                subDropdown.style.display = 'none';
            } else {
                if (categoryMatch) {
                    item.style.display = '';
                    subDropdown.style.display = 'none'; // Don't expand dropdown
                    // Show all subcategories because category matched
                    subcategories.forEach(sub => sub.parentElement.style.display = '');
                } else {
                    // Check for subcategory matches
                    let anySubMatch = false;
                    subcategories.forEach(function (sub) {
                        const subText = sub.innerText.toLowerCase();
                        const li = sub.parentElement;
                        if (subText.includes(filter)) {
                            li.style.display = '';
                            anySubMatch = true;
                        } else {
                            li.style.display = 'none';
                        }
                    });

                    if (anySubMatch) {
                        item.style.display = '';
                        subDropdown.style.display = 'block'; // Expand because subcategory matched
                    } else {
                        item.style.display = 'none';
                        subDropdown.style.display = 'none';
                    }
                }
            }
        });
    }

    function AdsListSearch() {
        var city = $('#city').val();
        var state = $('#state').val();
        var minPrice = $('#minPrice').val();
        var maxPrice = $('#maxPrice').val();
        var productName = $('#productName').val();

        // Construct query string from inputs
        var queryParams = `?strProductName=${encodeURIComponent(productName)}&strCity=${encodeURIComponent(city)}&strState=${encodeURIComponent(state)}&decMinPrice=${encodeURIComponent(minPrice)}&decMaxPrice=${encodeURIComponent(maxPrice)}`;

        // Navigate to the AdsList page with query params
        window.location.href = '/Dashboard/navSearch' + queryParams;
    }

    function applyFilters() {
        var categoryid = getUrlParameter('categoryid') || 0;
        var subcategoryid = getUrlParameter('subcategoryid') || 0;
        // ... your other filter parameters ...

        $.ajax({
            url: '/Dashboard/productList',
            type: 'POST',
            data: JSON.stringify({
                categoryid: categoryid,
                subcategoryid: subcategoryid,
                // ... other parameters ...
            }),
            contentType: 'application/json',
            success: function (result) {
                $('#productsContainer').html(result);
            }
        });
    }
    var acc = document.getElementsByClassName("accordion");
    var i;

    for (i = 0; i < acc.length; i++) {
        acc[i].addEventListener("click", function () {
            /* Toggle between adding and removing the "active" class,
            to highlight the button that controls the panel */
            this.classList.toggle("active");

            /* Toggle between hiding and showing the active panel */
            var panel = this.nextElementSibling;
            if (panel.style.display === "block") {
                panel.style.display = "none";
            } else {
                panel.style.display = "block";
            }
        });
    }

</script>
@section Scripts {
    <script>

        $(document).ready(function () {

            const urlParams = new URLSearchParams(window.location.search);
            const selectedCity = urlParams.get('city');
            const categoryId = urlParams.get('category');
            const subcategoryId = urlParams.get('subcategory');

            if (selectedCity) {

                $('.filter-city').each(function () {
                    if ($(this).val().toLowerCase() === selectedCity.toLowerCase()) {
                        $(this).prop('checked', true);
                    }
                });
         
                // Trigger existing filter logic
                $('.filter-city:checked').trigger('change');
            }

            if (categoryId && categoryId !== "0") {

                 updateCategory(categoryId);
            }

                // Delay ensures category loads first
            if (subcategoryId) {
                setTimeout(() => {
                    updateSubCategory(subCategoryId, categoryId);
                }, 300);
            }
        });
    </script>
}
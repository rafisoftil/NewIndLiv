@model List<IndiaLivings_Web_UI.Models.ServiceViewModel>
@{
    ViewBag.Title = "Services";
    <link rel="stylesheet" href="~/fonts/flaticon/flaticon.css" />
    <link rel="stylesheet" href="~/fonts/font-awesome/fontawesome.css" />
    <link rel="stylesheet" href="~/css/custom/ad-post.css" />
}
<style>
    .arrow-btn {
        background: none;
        border: none;
        outline: none;
        cursor: pointer;
        font-size: 18px;
        transition: transform 0.2s;
    }
    .arrow-btn.rotate {
        transform: rotate(90deg);
    }
    .subservices-row {
        background: #f8f9fa;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        border-radius: 0 0 8px 8px;
        padding: 0 32px 24px 32px;
        animation: fadeIn 0.3s;
    }
    .table-striped > tbody > tr.subservices-row > td {
        padding: 0;
        border-top: none;
    }
    .subservices-loading {
        text-align: center;
        padding: 32px;
    }
</style>
<section class="single-banner admin-banner">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div class="single-content">
                    <h2>Services Management</h2>
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a asp-action="Dashboard" asp-controller="Dashboard">Admin</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Services Management</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
</section>
<section class="admin-services-part">
    <div class="container">
        <!-- Services Statistics -->
        <div class="row">
            <div class="col-lg-3 col-sm-6">
                <div class="admin-stat-card">
                    <div class="stat-content">
                        <h4>324</h4>
                        <p>Total Services</p>
                    </div>
                    <div class="stat-icon">
                        <i class="fas fa-tools"></i>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-sm-6">
                <div class="admin-stat-card">
                    <div class="stat-content">
                        <h4>45</h4>
                        <p>Pending Approval</p>
                    </div>
                    <div class="stat-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-sm-6">
                <div class="admin-stat-card">
                    <div class="stat-content">
                        <h4>278</h4>
                        <p>Active Services</p>
                    </div>
                    <div class="stat-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-sm-6">
                <div class="admin-stat-card">
                    <div class="stat-content">
                        <h4>156</h4>
                        <p>Service Providers</p>
                    </div>
                    <div class="stat-icon">
                        <i class="fas fa-users"></i>
                    </div>
                </div>
            </div>
        </div>
        <!-- Services Management Content -->
        <div class="row">
            <div class="col-lg-12">
                <div class="admin-content-card">
                    <!-- Only All Services Tab -->
                    <div class="content-header">
                        <h4>All Services</h4>
                        <div class="content-actions">
                            <button class="btn btn-primary" data-toggle="modal" data-target="#AddServicesModal">
                                <i class="fas fa-plus"></i> Add New Service
                            </button>
                            @* <button class="btn btn-outline-secondary" onclick="exportServices()">
                                <i class="fas fa-download"></i> Export
                            </button> *@
                        </div>
                    </div>
                    <!-- Services Table -->
                    <div class="table-responsive">
                        <table class="table table-striped" id="servicesTable">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th>ID</th>
                                    <th>Service Name</th>
                                    <th>Description</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                            @{
                                int serial = 0;
                            }
                            @foreach(var service in Model)
                            {
                                serial = serial + 1;
                                <tr data-serviceid="@service.CategoryId">
                                    <td style="width:40px;text-align:center;">
                                        <button class="arrow-btn" onclick="toggleSubservices(this, @service.CategoryId)" aria-label="Show subservices">
                                            <i class="fa fa-chevron-right"></i>
                                        </button>
                                    </td>
                                    <td>@serial</td>
                                    <td><span class="category-tag">@service.Name</span></td>
                                    <td><span>@service.Description</span></td>
                                    <td><span class="status-badge active">@(service.IsActive ? "Active" : "InActive")</span></td>
                                    <td>
                                        <div class="action-buttons">
                                            <button class="btn-outline-secondary"
                                                onclick="editService(this)"
                                                data-id="@service.CategoryId"
                                                data-name="@service.Name"
                                                data-slug="@service.Slug"
                                                data-description="@service.Description"
                                                data-status="@service.IsActive">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="ml-3 btn-outline-danger" onclick="deleteService(@service.CategoryId)">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                <tr class="subservices-row" id="subservices-row-@service.CategoryId" style="display:none;">
                                    <td colspan="8">
                                        <div class="subservices-loading" id="subservices-loading-@service.CategoryId" style="display:none;">
                                            <img src="~/images/spinner.gif" style="height:40px;" /> Loading subservices...
                                        </div>
                                        <div class="subservices-content" id="subservices-content-@service.CategoryId"></div>
                                    </td>
                                </tr>
                            }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<!-- Modal to display subservices inline without leaving the page -->
<div class="modal fade" id="subservicesModal" tabindex="-1" aria-labelledby="subservicesLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="subservicesLabel">Subservices</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="subservicesModalBody" style="min-height:200px;">
                <div id="subservicesSpinner" style="display:none;text-align:center;padding:40px;"><img src="~/images/spinner.gif" style="height:60px;" /></div>
                <div id="subservicesContent"></div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="AddServicesModal" tabindex="-1" aria-labelledby="addCategoryLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h4 class="modal-title text-white" id="addCategoryLabel">Add New Service Category</h4>
                <button type="button" class="btn-close btn-close-white" data-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addCategoryForm">
                    <div class="mb-3">
                        <label for="name" class="form-label">Category Name</label>
                        <input name="name" id="name" class="form-control" placeholder="Enter category name" required />
                    </div>
                    <div class="mb-3">
                        <label for="slug" class="form-label">Slug</label>
                        <input name="slug" id="slug" class="form-control" placeholder="Enter slug" required />
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <input name="description" id="description" class="form-control" placeholder="Enter description" required />
                    </div>
                    <div class="mb-3">
                        <label for="image" class="form-label">Image Icon</label>
                        <input name="image" id="image" class="form-control" placeholder="Enter a Image Icon" required />
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="AddNewCategoryService()">Add Category</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="EditServicesModal" tabindex="-1" aria-labelledby="addCategoryLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h4 class="modal-title text-white" id="addCategoryLabel">Edit Service Category</h4>
                <button type="button" class="btn-close btn-close-white" data-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="mb-3">
                        <label for="name" class="form-label">Category Name</label>
                        <input name="name" id="name" class="form-control" placeholder="Enter category name" />
                    </div>
                    <div class="mb-3">
                        <label for="slug" class="form-label">Slug</label>
                        <input name="slug" id="slug" class="form-control" placeholder="Enter slug" />
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <input name="description" id="description" class="form-control" placeholder="Enter description" />
                    </div>
                    <div class="mb-3">
                        <label for="status" class="form-label">Status</label>
                        <select id="status" class="form-control">
                            <option value="true">Active</option>
                            <option value="false">Inactive</option>
                        </select>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="updateCategory()">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div id="spinner" class="d-none">
    <img style="height: 100px" src="~/images/spinner.gif" />
</div>
<div id="toast" class="d-none"></div>
<script src="~/Scripts/jquery-3.6.0.min.js"></script>
<script>
    // Accordion dropdown for subservices
    function toggleSubservices(btn, categoryId) {
        // Close any open subservices
        $(".subservices-row").hide();
        $(".arrow-btn").removeClass("rotate");
        // If already open, close and return
        var $row = $("#subservices-row-" + categoryId);
        if ($row.is(":visible")) {
            $row.hide();
            return;
        }
        // Rotate arrow
        $(btn).addClass("rotate");
        // Show loading
        $("#subservices-loading-" + categoryId).show();
        $row.show();
        // Load subservices via AJAX
        $.ajax({
            url: '/Service/AdminSubServices',
            type: 'GET',
            data: { categoryId: categoryId },
            success: function (response) {
                $("#subservices-loading-" + categoryId).hide();
                $("#subservices-content-" + categoryId).html(response);
            },
            error: function () {
                $("#subservices-loading-" + categoryId).hide();
                $("#subservices-content-" + categoryId).html('<div class="text-danger">No Subservices Under this Service.</div>');
            }
        });
    }
</script>
<script>
    function AddNewSubCategoryService() {
        // Manual validation in JavaScript
        var categoryid = $('#add_categoryid').val().trim();
        var name = $('#add_name').val().trim();
        var basePrice = $('#add_basePrice').val().trim();
        var description = $('#add_description').val().trim();
        var durationMin = $('#add_durationMin').val().trim();
        var errors = [];

        if (!name) {
            errors.push('Category Name is required.');
            $('#add_name').addClass('is-invalid');
        } else if (name.length > 100) {
            errors.push('Category Name cannot exceed 100 characters.');
            $('#add_name').addClass('is-invalid');
        } else {
            $('#add_name').removeClass('is-invalid');
        }

        if (!basePrice) {
            errors.push('basePrice is required.');
            $('#add_basePrice').addClass('is-invalid');
        } else if (basePrice.length > 120) {
            errors.push('basePrice cannot exceed 120 characters.');
            $('#add_basePrice').addClass('is-invalid');
        } else {
            $('#add_basePrice').removeClass('is-invalid');
        }

        if (!description) {
            errors.push('Description is required.');
            $('#add_description').addClass('is-invalid');
        } else if (description.length > 512) {
            errors.push('Description cannot exceed 512 characters.');
            $('#add_description').addClass('is-invalid');
        } else {
            $('#add_description').removeClass('is-invalid');
        }

        if (errors.length > 0) {
            ShowToast('failed', errors.join('\n'));
            return false;
        }

        if (!durationMin) {
            errors.push('durationMin is required.');
            $('#add_durationMin').addClass('is-invalid');
        } else if (durationMin.length > 256) {
            errors.push('durationMin cannot exceed 256 characters.');
            $('#add_durationMin').addClass('is-invalid');
        } else {
            $('#add_durationMin').removeClass('is-invalid');
        }

            $.ajax({
                url: '/Service/CreateServiceSubCategory',
                type: 'POST',
                data: {categoryid: categoryid, name: name, basePrice: basePrice, description: description, durationMin: durationMin },
                success: function (response) {
                    if (response.success) {
                        ShowToast('success', 'Service added successfully!');
                        location.reload();
                    } else {
                        ShowToast('Failed', 'Error adding Service');
                    }
                },
                error: function () {
                    ShowToast('Failed', 'Error adding category');
                }
            });
            $('#AddCategoryModal').modal('hide');
    }

    function editSubService(btn) {
        var serviceid = $(btn).data('serviceid');
        var id = $(btn).data('categoryid');
        var name = $(btn).data('name');
        var baseprice = $(btn).data('baseprice');
        var description = $(btn).data('description');
        var status = $(btn).data('status');
        var minduration = $(btn).data('duration');
        // Fill modal fields
        $('#EditCategoryModal').modal('show');
        $('#edit_serviceid').val(serviceid);
        $('#edit_categoryid').val(id);
        $('#edit_name').val(name);
        $('#edit_basePrice').val(baseprice);
        $('#edit_description').val(description);
        $('#edit_status').val(String(status).toLowerCase());
        $('#edit_durationMin').val(minduration);
        $('#EditCategoryModal').data('category-id', id);
    }

    // Admin Functions
    function addNewService() {
        alert('Opening Add New Service Modal');
        // Open add service modal
    }

    function viewService(serviceId) {
        alert('Viewing service details for ID: ' + serviceId);
        // Open service details modal
    }

    function editService(btn) {
        // Get data from button attributes
        var id = $(btn).data('id');
        var name = $(btn).data('name');
        var slug = $(btn).data('slug');
        var description = $(btn).data('description');
        var status = $(btn).data('status');

        // Fill modal fields
        $('#EditServicesModal').modal('show');
        $('#EditServicesModal input#name').val(name);
        $('#EditServicesModal input#slug').val(slug);
        $('#EditServicesModal input#description').val(description);
        $('#EditServicesModal select#status').val(String(status).toLowerCase());
        $('#EditServicesModal').data('category-id', id);
    }

    function deleteService(serviceId) {
        if (confirm('Are you sure you want to delete this service?')) {
            alert('Service deleted: ' + serviceId);
            // Handle service deletion
        }
    }

    function approveService(serviceId) {
        if (confirm('Approve this service?')) {
            alert('Service approved: ' + serviceId);
            // Handle service approval
        }
    }

    function rejectService(serviceId) {
        if (confirm('Reject this service?')) {
            alert('Service rejected: ' + serviceId);
            // Handle service rejection
        }
    }

    function exportServices() {
        alert('Exporting services data...');
        // Handle export functionality
    }

    function addNewCategory() {
        alert('Opening Add New Category Modal');
        // Open add category modal
    }

    function editCategory(categoryId) {
        alert('Editing category ID: ' + categoryId);
        // Open edit category modal
    }

    function deleteCategory(categoryId) {
        if (confirm('Are you sure you want to delete this category?')) {
            alert('Category deleted: ' + categoryId);
            // Handle category deletion
        }
    }

    function approveAllSelected() {
        const selected = $('input[name="pending_services[]"]:checked').length;
        if (selected > 0) {
            if (confirm('Approve ' + selected + ' selected services?')) {
                alert('Approved ' + selected + ' services');
                // Handle bulk approval
            }
        } else {
            alert('Please select services to approve');
        }
    }

    function rejectAllSelected() {
        const selected = $('input[name="pending_services[]"]:checked').length;
        if (selected > 0) {
            if (confirm('Reject ' + selected + ' selected services?')) {
                alert('Rejected ' + selected + ' services');
                // Handle bulk rejection
            }
        } else {
            alert('Please select services to reject');
        }
    }

    function viewServiceDetails(serviceId) {
        alert('Viewing detailed review for service ID: ' + serviceId);
        // Open detailed service review modal
    }

    function AddNewCategoryService() {
        // Manual validation in JavaScript
        var name = $('#name').val().trim();
        var slug = $('#slug').val().trim();
        var description = $('#description').val().trim();
        var image = $('#image').val().trim();
        var errors = [];

        if (!name) {
            errors.push('Category Name is required.');
            $('#name').addClass('is-invalid');
        } else if (name.length > 100) {
            errors.push('Category Name cannot exceed 100 characters.');
            $('#name').addClass('is-invalid');
        } else {
            $('#name').removeClass('is-invalid');
        }

        if (!slug) {
            errors.push('Slug is required.');
            $('#slug').addClass('is-invalid');
        } else if (slug.length > 120) {
            errors.push('Slug cannot exceed 120 characters.');
            $('#slug').addClass('is-invalid');
        } else {
            $('#slug').removeClass('is-invalid');
        }

        if (!description) {
            errors.push('Description is required.');
            $('#description').addClass('is-invalid');
        } else if (description.length > 512) {
            errors.push('Description cannot exceed 512 characters.');
            $('#description').addClass('is-invalid');
        } else {
            $('#description').removeClass('is-invalid');
        }

        if (errors.length > 0) {
            ShowToast('failed', errors.join('\n'));
            return false;
        }

        if (!image) {
            errors.push('Image Icon is required.');
            $('#image').addClass('is-invalid');
        } else if (image.length > 256) {
            errors.push('Image Icon cannot exceed 256 characters.');
            $('#image').addClass('is-invalid');
        } else {
            $('#image').removeClass('is-invalid');
        }

            $.ajax({
                url: '/Service/AddServiceCategory',
                type: 'POST',
                data: { name: name, slug: slug, description: description, image: image },
                success: function (response) {
                    if (response.success) {
                        ShowToast('success', 'Category added successfully!');
                        location.reload();
                    } else {
                        ShowToast('Failed', 'Error adding category');
                    }
                },
                error: function () {
                    ShowToast('Failed', 'Error adding category');
                }
            });
            $('#AddServicesModal').modal('hide');
    }

    function updateCategory() {
        // Manual validation in JavaScript
        const id = $('#EditServicesModal').data('category-id');
        const name = $('#EditServicesModal input#name').val().trim();
        const slug = $('#EditServicesModal input#slug').val().trim();
        const description = $('#EditServicesModal input#description').val().trim();
        const status = $('#EditServicesModal select#status').val() === 'true';
        var errors = [];

        if (!name) {
            errors.push('Category Name is required.');
            $('#EditServicesModal input#name').addClass('is-invalid');
        } else if (name.length > 100) {
            errors.push('Category Name cannot exceed 100 characters.');
            $('#EditServicesModal input#name').addClass('is-invalid');
        } else {
            $('#EditServicesModal input#name').removeClass('is-invalid');
        }

        if (!slug) {
            errors.push('Slug is required.');
            $('#EditServicesModal input#slug').addClass('is-invalid');
        } else if (slug.length > 120) {
            errors.push('Slug cannot exceed 120 characters.');
            $('#EditServicesModal input#slug').addClass('is-invalid');
        } else {
            $('#EditServicesModal input#slug').removeClass('is-invalid');
        }

        if (!description) {
            errors.push('Description is required.');
            $('#EditServicesModal input#description').addClass('is-invalid');
        } else if (description.length > 512) {
            errors.push('Description cannot exceed 512 characters.');
            $('#EditServicesModal input#description').addClass('is-invalid');
        } else {
            $('#EditServicesModal input#description').removeClass('is-invalid');
        }

        if (errors.length > 0) {
            ShowToast('failed', errors.join('\n'));
            return false;
        }

        $.ajax({
            url: '/Service/UpdateServiceCategory',
            type: 'PUT',
            data: { categoryId: id, name: name, slug: slug, description: description, isActive: status },
            success: function (response) {
                if (response.success) {
                    ShowToast('success', 'Category updated successfully!');
                    location.reload();
                } else {
                    ShowToast('failed', 'Error updating category');
                }
            },
            error: function () {
                alert('Error updating category.');
            }
        });
        $('#EditServicesModal').modal('hide');
    }

    function deleteService(categoryId) {
        $.ajax({
            url: '/Service/DeleteServiceCategory',
            type: 'DELETE',
            data: { categoryId: categoryId },
            success: function (response) {
                if (response.success) {
                    ShowToast('success', 'Category deleted successfully!');
                    location.reload();
                } else {
                    ShowToast('failed', 'Error deleting category');
                }
            },
            error: function () {
                alert('Error deleting category.');
            }
        });
    }
    function deleteSubcategoryModal(serviceid, servicename) {
        $('#subservice-name').text(servicename);
        $('#deletesubcategory-id').val(serviceid);
        $('#DeleteSubservicesModal').modal('show');
    }
    function deleteSubcategory() {
       var serviceid = $('#deletesubcategory-id').val();
       $('#DeleteSubservicesModal').modal('hide');
       $.ajax({
           url: '/Service/DeleteServiceSubCategory',
           type: 'POST',
           data: {serviceId: serviceid},
           success: function (response) {
               if (response.success) {
                    ShowToast('success', 'Category deleted successfully!');
                    location.reload();
                } else {
                    ShowToast('failed', 'Error deleting category');
                }
            },
            error: function () {
                alert('Error deleting category.');
           }
       })
    }
    // function viewService(categoryId) 
    // {
    //     $.ajax({
    //         url: '/Service/ServiceDetails',
    //         type: 'GET',
    //         data: { categoryId: categoryId },
    //         success: function (response) {
    //             if (response) {
    //                 alert('Category details: ' + JSON.stringify(response));
    //                 // Populate and show modal with category details
    //             } else {
    //                 alert('Error fetching category details: ' + response);
    //             }
    //         },}
    //     })
    // }
</script>
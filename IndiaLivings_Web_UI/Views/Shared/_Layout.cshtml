<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - IndiaLeavings</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    @* <link rel="stylesheet" href="~/India_Leavings_Web_UI.styles.css" asp-append-version="true" /> *@
    <!-- FAVICON -->
    <link rel="icon" href="images/favicon.png">

    <!-- FONTS -->
    @* <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" integrity="sha384-k6RqeWeci5ZR/Lv4MR0sA0FfDOMMb12QKmrCGLR7IxJ6kvTEh8P5F06IMj6mvZ0d" crossorigin="anonymous"> *@
    <link rel="stylesheet" href="~/fonts/flaticon/flaticon.css" />
    <link rel="stylesheet" href="~/fonts/font-awesome/fontawesome.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/custom/main.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/mvc-grid/mvc-grid.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/custom/services.css">
    @* <link rel="stylesheet" href="~/css/vendor/bootstrap.min.css" /> *@
    <style>
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            min-width: 250px;
            max-width: 350px;
            padding: 15px;
            border-radius: 4px;
            z-index: 9999;
            display: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            font-size: 1rem;
            animation: fadeIn 0.3s;
        }

        .toast-success {
            background-color: #4CAF50;
            color: white;
        }

        .toast-info {
            background-color: #2196F3;
            color: white;
        }

        .toast-message {
            background-color: #333;
            color: #fff;
        }
    </style>
</head>
<body>
    <div id="notification-toast" class="toast"></div>
    <partial name="~/Views/Shared/_Header.cshtml" />
    <partial name="~/Views/Shared/_SideBar.cshtml" />
    <main role="main" class="pb-3">
        @RenderBody()
    </main>

    <partial name="~/Views/Shared/_Footer.cshtml" />
    <script type="text/javascript" src="~/js/mvc-grid/mvc-grid.js"></script>
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js"></script>
    <script src="~/js/vendor/slick.min.js"></script>
    <script src="~/js/custom/slick.js"></script>
    <script src="~/js/custom/main.js"></script>
    <script src="~/js/vendor/jquery-1.12.4.min.js"></script>
    <script src="~/js/vendor/popper.min.js"></script>
    <script src="~/js/vendor/bootstrap.min.js"></script>
    <script src="~/js/mvc-grid/mvc-grid.js"></script>
    <script src="~/js/jobnews.pagination.js"></script>

    @await RenderSectionAsync("Scripts", required: false)
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/5.0.11/signalr.min.js"></script>
    <script>
        $(document).ready(function () {
            const userId = '@Context.Session.GetInt32("UserId")';
            if (!userId) return;
            loadUnreadCount(userId);
            loadUnreadNotificationCount(userId);

            // Create connection to chatHub for messages
            const chatConnection = new signalR.HubConnectionBuilder()
                .withUrl("/chatHub")
                .withAutomaticReconnect()
                .build();

            chatConnection.start()
                .then(() => console.log("Connected to chat hub"))
                .catch(err => console.error("Chat hub error:", err));

            // Listen for UpdateUnreadCount event
            chatConnection.on("UpdateUnreadCount", function (receiverId) {
                console.log("UpdateUnreadCount received for user:", receiverId);
                loadUnreadCount(userId); // refresh unread message count
            });

            function loadUnreadCount(uid) {
                $.get(`/User/GetUnreadMessageCount?userId=${uid}`, function (msgCount) {
                    console.log("Unread count updated:", msgCount);
                    $('.msg-count').text(msgCount || 0);
                }).fail(err => console.error("Failed to load unread count:", err));
            }

            const notificationCount = new signalR.HubConnectionBuilder()
                .withUrl("/notificationHub")
                .withAutomaticReconnect()
                .build();

            notificationCount.start()
                .then(() => console.log("Connected to notification hub"))
                .catch(err => console.error(err));

            notificationCount.on("UpdateUnreadNotificationCount", function (receiverId) {
                console.log("UpdateUnreadNotificationCount received for user:", receiverId);
                loadUnreadNotificationCount(userId); // refresh unread notification count
            });

            function loadUnreadNotificationCount(uid) {
                $.get(`/User/GetUnreadNotificationCount?userId=${uid}`, function (msgCount) {
                    console.log("Unread count updated:", msgCount);
                    $('.notification-count').text(msgCount || 0);
                }).fail(err => console.error("Failed to load unread count:", err));
            }
        });

        const notificationConnection = new signalR.HubConnectionBuilder()
            .withUrl("/notificationHub")
            .withAutomaticReconnect()
            .build();

        notificationConnection.start()
            .then(() => console.log("Connected to notification hub"))
            .catch(err => console.error(err));

        notificationConnection.on("ReceiveNotification", function(notification) {
            playNotificationSound();
            showToast(notification.message, notification.type);
            if (typeof updateNotificationList === "function") {
                updateNotificationList(notification);
            }
        });

        function showToast(message, type) {
            const toast = document.getElementById("notification-toast");
            toast.className = `toast toast-${type || "info"}`;
            toast.textContent = message;
            toast.style.display = "block";
            setTimeout(() => toast.style.display = "none", 5000);
        }

        function playNotificationSound() {
            let audio = document.getElementById("notificationSound");
            if (!audio) {
                audio = document.createElement("audio");
                audio.id = "notificationSound";
                audio.src = "/sounds/noti.mp3";
                audio.preload = "auto";
                document.body.appendChild(audio);
            }
            audio.currentTime = 0;
            audio.play().catch(err => console.log("Audio play failed:", err));
        }
    </script>
</body>
</html>
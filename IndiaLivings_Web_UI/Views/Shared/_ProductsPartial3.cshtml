@model List<ProductViewModel>
<style>
    .product-card:hover {
        transform: scale(1.1);
        box-shadow: 0 10px 20px rgba(0,0,0,0.15);
        z-index: 2;
    }

    .rating-size:hover {
        transform: scale(1.5);
    }
</style>
@{
    List<int> wishlistIds = ViewBag.WishlistIds ?? new List<int>();
    int itemsPerPage = ViewBag.ItemsPerPage;
    int currentPage = ViewBag.CurrentPage;
    double modelCount = Model.Count();
    var pagedProducts = Model.Skip(itemsPerPage * (currentPage - 1)).Take(itemsPerPage).ToList();
    int productsOnPage = pagedProducts.Count;
}
<div class="row ad-standard">
@foreach (var product in pagedProducts)
{
    <div class="col-sm-12 col-md-12 col-lg-12 col-xl-12">
        <div class="product-card standard">
            <div class="product-media">
                <div class="product-img" style="height:190px; width:280px">
                    <img src="data:image/png;base64,@Convert.ToBase64String(product.byteProductImageData)"
                             onerror="this.onerror=null; this.src='/images/no-image.png';"
                         alt="@product.productImageName" style="height:190px; width:280px" />
                </div>
                <div class="cross-vertical-badge product-badge">
                    <i class="fas fa-clipboard-check"></i>
                    <span>recommend</span>
                </div>
                <div class="product-type">
                    <span class="flat-badge @(product.productAdCategory.ToLower())">@product.productAdCategory</span>
                </div>
                <ul class="product-action">
                    @* <li class="view"><i class="fas fa-eye"></i><span>264</span></li>
                    <li class="click"><i class="fas fa-mouse"></i><span>134</span></li> *@
                    <li class="rating"><i class="fas fa-star"></i><span>@((product.averageRating != 0) ? @product.averageRating + "/5" : "NA")</span></li>
                </ul>
            </div>
            <div class="product-content">
                <ol class="breadcrumb product-category">
                    <li><i class="fas fa-tags"></i></li>
                    <li class="breadcrumb-item"><a href="#">@product.productCategoryName</a></li>
                    <li class="breadcrumb-item active" aria-current="page">@product.productSubCategoryName</li>
                </ol>
                <h5 class="product-title">
                    <a href="#">@product.productName</a>
                </h5>
                <div class="product-meta">
                    <span><i class="fas fa-map-marker-alt"></i>@product.userContactCity</span>
                    <span><i class="fas fa-clock"></i>@product.updatedDate.ToString("dd MMM yyyy")</span>
                </div>
                <div class="product-info">
                    <h5 class="product-price">₹@Convert.ToInt32(product.productPrice)<span>/@product.productPriceCondition</span></h5>
                    <div class="product-btn">
                            <a asp-action="ProductDetails" asp-controller="User" asp-route-username="@product.createdBy" asp-route-productId="@product.productId" title="Contact Seller" class="fas fa-eye"></a>
                        <a href='#' class='fas fa-compress'
                           data-toggle='modal' data-target='#productDetailsModal'
                           onclick='populateModal(@Html.Raw(System.Text.Json.JsonSerializer.Serialize(product)))'>
                        </a>
                        <button type="button" title="Wishlist" class="@(wishlistIds.Contains(product.productId) ? "far fa-heart fas" : "far fa-heart")"
                                onclick="AddToWishlist(this, '@product.productId', '@product.createdBy')"></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
}
</div>
<div class="row">
    <div class="col-lg-12">
        <div class="footer-pagection">
            <p class="page-info">Showing @((itemsPerPage * ViewBag.CurrentPage < ViewBag.Count) ? itemsPerPage * ViewBag.CurrentPage : ViewBag.Count) of @ViewBag.Count Results</p>
            <ul class="pagination" id="pagination">
                <li class="page-item">
                    <a class="page-link" onclick="previousPage()">
                        <i class="fas fa-long-arrow-alt-left"></i>
                    </a>
                </li>
                @* Page numbers will be inserted dynamically *@
                <li class="page-item">
                    <a class="page-link" onclick="nextPage()">
                        <i class="fas fa-long-arrow-alt-right"></i>
                    </a>
                </li>
            </ul>
        </div>
    </div>
</div>
<script>
    function AddToWishlist(button, productID, createdBy) {
        const loggedUserId = '@Context.Session.GetInt32("UserId")';

        if (!loggedUserId || loggedUserId === "null") {
            window.location.href = "/Dashboard/Login";
            return;
        }

        var isInWishlist = button.classList.contains("fas");
        if (isInWishlist) {
            button.classList.replace("fas", "far");
        }
        else {
            button.classList.replace("far", "fas");
        }
        $.ajax({
            url: '/User/UpdateBookmarks',
            type: 'POST',
            data: { productID: productID, createdBy: createdBy, status: isInWishlist ? 0 : 1 },
            success: function (response) {
                if (response.statusCode != 200) {
                    alert('Error in processing request.');
                }
                else {
                    UpdateWishlistCount();
                }
            },
            error: function () {
                alert('Error in processing request.');
            }
        });
    }
    let totalPages = @Math.Ceiling((double)modelCount / itemsPerPage);
    let currentPage = @currentPage;
    const visiblePages = 5;

    function renderPagination() {
        const pagination = document.getElementById('pagination');
        const pageLinks = pagination.querySelectorAll('.page-item');

        // Remove old page number items (excluding arrows)
        pageLinks.forEach((item, index) => {
            if (index !== 0 && index !== pageLinks.length - 1) {
                item.remove();
            }
        });

        // Calculate startPage and endPage with fixed visiblePages
        let half = Math.floor(visiblePages / 2);
        let startPage = currentPage - half;
        let endPage = currentPage + half;

        if (startPage < 1) {
            startPage = 1;
            endPage = visiblePages;
        }

        if (endPage > totalPages) {
            endPage = totalPages;
            startPage = Math.max(1, totalPages - visiblePages + 1);
        }

        const insertBefore = pagination.children[pagination.children.length - 1];

        for (let i = startPage; i <= endPage; i++) {
            const li = document.createElement('li');
            li.className = `page-item ${i === currentPage ? 'active' : ''}`;
            li.innerHTML = `<a class="page-link" onclick="goToPage(${i})">${i}</a>`;
            pagination.insertBefore(li, insertBefore);
        }
    }

    function goToPage(page) {
        currentPage = page;
        renderPagination();
        changePage(null, page); // Your actual logic to load page content
    }

    function previousPage() {
        if (currentPage > 1) {
            goToPage(currentPage - 1);
        }
    }

    function nextPage() {
        if (currentPage < totalPages) {
            goToPage(currentPage + 1);
        }
    }

    // Initial render
    renderPagination();

    function populateModal(product) {
        // const starRating = document.getElementById('starRating');
        // starRating.setAttribute('data-selected', '0');

        // const stars = starRating.querySelectorAll('.fa-star');
        // stars.forEach(star => {
        //     star.classList.remove('selected');
        // });

        // document.getElementById('selectedRating').value  = "0";
        // if (typeof product === "string") {
        //     product = JSON.parse(product);
        // }

        var myModal = new bootstrap.Modal(document.getElementById('productDetailsModal'));
        myModal.show();

        var image = $('#image-modal');
        var status = product.IsActiveStatus;
        var reviewStatus = product.productAdminReviewStatus;

        $('#productId-modal').attr('data-product-id', product.productId);
        $('#productId-modal').val(product.productId);
        $('#productName-modal').text(product.productName);
        $('#productCategory-modal').text(product.productCategoryName);
        $('#productQuantity-modal').text(product.productQuantity);
        $('#productPrice-modal').text(`$${product.productPrice}`);
        $('#productOwner-modal').text(product.createdBy);
        $('#productDescription-modal').text(product.productDescription);
        $('#productPublished-modal').text(product.createdDate);
        $('#productStatus-modal').text(status).attr('data-product-status', status);

        if (product.byteProductImageData) {
            image.attr("src", "data:image/jpeg;base64," + product.byteProductImageData);
        } else {
            image.attr("src", "/images/no-image.png"); // ✅ Replace with your actual default image path
        }
    }

    function changePage(curPage, page) {
        $('.pagination .page-link').removeClass('active');

        // Add "active" class to the clicked page
        $(curPage).addClass('active');
        $.ajax({
            url: '/Dashboard/ProductsList3?page=' + page + '&itemsPerPage=' + itemsPerPage,
            type: 'POST',
            data: JSON.stringify(@Html.Raw(Json.Serialize(Model))),
            contentType: 'application/json',
            success: function (data) {
                $('#divPartial').html(data);
            },
            error: function () {
                alert('Failed to load products.');
            }
        });
    }

    function selectRating(elem) {
        const value = parseInt($(elem).data("value"));
        $("#selectedRating").val(value);
        var rating = $("#selectedRating").val();
        $(elem).siblings().addClass("selected");
        $(elem).addClass("selected");
        $(elem).prevAll().removeClass("selected");
        submitRating(rating);
    }

    function submitRating(rating) {
        const productId = $('#productId-modal').val();
        $.ajax({
            url: '/User/AddRating',
            type: 'POST',
            data: { productId: productId, rating: rating },
            success: function (response) {
                if (response.status.includes("added")){
                    ShowToast("success", "Rating added successfully");
                } else {
                    ShowToast("failed", "An Error occured");
                }
            },
            error: function () {
                alert("Error submitting rating.");
            }

        });
    }
    function changeGridView() {
        //$('.pagination .page-link').removeClass('active');

        // Add "active" class to the clicked page
        //$(curPage).addClass('active');
        $('#grid1').addClass('active');
        $('#grid2').removeClass('active');
        $('#grid3').removeClass('active');
        $.ajax({
            url: '/Dashboard/ProductsList?itemsPerPage=' + @itemsPerPage,
            type: 'POST',
            data: JSON.stringify(@Html.Raw(Json.Serialize(Model))),
            contentType: 'application/json',
            success: function (data) {
                $('#divPartial').html(data);
            },
            error: function () {
                alert('Failed to load products.');
            }
        });
    }

    function changeGridView2() {
        //$('.pagination .page-link').removeClass('active');

        // Add "active" class to the clicked page
        //$(curPage).addClass('active');
        $('#grid1').removeClass('active');
        $('#grid2').addClass('active');
        $('#grid3').removeClass('active');
        $.ajax({
            url: '/Dashboard/ProductsList2?itemsPerPage=' + @itemsPerPage,
            type: 'POST',
            data: JSON.stringify(@Html.Raw(Json.Serialize(Model))),
            contentType: 'application/json',
            success: function (data) {
                $('#divPartial').html(data);
            },
            error: function () {
                alert('Failed to load products.');
            }
        });
    }

    function changeGridView3() {
        //$('.pagination .page-link').removeClass('active');

        // Add "active" class to the clicked page
        //$(curPage).addClass('active');
        $('#grid1').removeClass('active');
        $('#grid2').removeClass('active');
        $('#grid3').addClass('active');
        $.ajax({
            url: '/Dashboard/ProductsList3?itemsPerPage=' + @itemsPerPage,
            type: 'POST',
            data: JSON.stringify(@Html.Raw(Json.Serialize(Model))),
            contentType: 'application/json',
            success: function (data) {
                $('#divPartial').html(data);
            },
            error: function () {
                alert('Failed to load products.');
            }
        });
    }

</script>
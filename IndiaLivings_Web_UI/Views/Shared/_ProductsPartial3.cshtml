@model List<FilteredAd>
<style>
    .product-card:hover {
        transform: scale(1.1);
        box-shadow: 0 10px 20px rgba(0,0,0,0.15);
        z-index: 2;
    }

    .rating-size:hover {
        transform: scale(1.5);
    }
</style>
@{
    List<int> wishlistIds = ViewBag.WishlistIds ?? new List<int>();
    int itemsPerPage = 36;
    int TotalCount = (ViewBag.TotalCount != null) ? (int)ViewBag.TotalCount : 0;
    int CurrentPage = (ViewBag.CurrentPage != null && (int)ViewBag.CurrentPage > 0) ? (int)ViewBag.CurrentPage : 1;
}
<div class="row ad-standard">
@foreach (var product in Model)
{
    <div class="col-sm-12 col-md-12 col-lg-12 col-xl-12">
        <div class="product-card standard">
            <div class="product-media">
                <div class="product-img" style="height:190px; width:280px">
                        <img src="@Url.Action("GetProductImage", "Dashboard", new { productId = product.ProductId })"
                             onerror="this.onerror=null;this.src='/images/no-image.png';"
                             alt="@product.ProductName" style="height:190px; width:280px" />
                </div>
                <div class="cross-vertical-badge product-badge">
                    <i class="fas fa-clipboard-check"></i>
                    <span>recommend</span>
                </div>
                <div class="product-type">
                    <span class="flat-badge @(product.ProductAdCategory.ToLower())">@product.ProductAdCategory</span>
                </div>
                <ul class="product-action">
                    @* <li class="view"><i class="fas fa-eye"></i><span>264</span></li>
                    <li class="click"><i class="fas fa-mouse"></i><span>134</span></li> *@
                    <li class="rating"><i class="fas fa-star"></i><span>@((product.AverageRating != 0) ? @product.AverageRating + "/5" : "NA")</span></li>
                </ul>
            </div>
            <div class="product-content">
                <ol class="breadcrumb product-category">
                    <li><i class="fas fa-tags"></i></li>
                    <li class="breadcrumb-item"><a href="#">@product.CategoryName</a></li>
                    <li class="breadcrumb-item active" aria-current="page">@product.SubCategoryName</li>
                </ol>
                <h5 class="product-title">
                    <a href="#">@product.ProductName</a>
                </h5>
                <div class="product-meta">
                    <span><i class="fas fa-map-marker-alt"></i>@product.UserContactCity</span>
                    <span><i class="fas fa-clock"></i>@product.UpdatedDate.ToString("dd MMM yyyy")</span>
                </div>
                <div class="product-info">
                    <h5 class="product-price">₹@Convert.ToInt32(product.ProductPrice)<span>/@product.ProductPriceCondition</span></h5>
                    <div class="product-btn">
                        <a asp-action="ProductDetails" asp-controller="User" asp-route-username="@product.ProductOwner" asp-route-productId="@product.ProductId" title="Contact Seller" class="fas fa-eye"></a>
                        <button type="button" title="Wishlist" class="@(wishlistIds.Contains(product.ProductId) ? "far fa-heart fas" : "far fa-heart")"
                                    onclick="AddToWishlist(this, '@product.ProductId', '@product.ProductOwner')"></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
}
</div>
<div class="row">
    <div class="col-lg-12">
        <div class="footer-pagection">
            <p class="page-info">Showing @((itemsPerPage * ViewBag.CurrentPage < ViewBag.Count) ? itemsPerPage * ViewBag.CurrentPage : ViewBag.Count) of @ViewBag.Count Results</p>
            <ul class="pagination" id="pagination">
                <li class="page-item">
                    <a class="page-link" onclick="previousPage()">
                        <i class="fas fa-long-arrow-alt-left"></i>
                    </a>
                </li>
                @* Page numbers will be inserted dynamically *@
                <li class="page-item">
                    <a class="page-link" onclick="nextPage()">
                        <i class="fas fa-long-arrow-alt-right"></i>
                    </a>
                </li>
            </ul>
        </div>
    </div>
</div>
<script>

    function AddToWishlist(button, productID, createdBy) {
        const loggedUserId = '@Context.Session.GetInt32("UserId")';

        if (!loggedUserId || loggedUserId === "null") {
            window.location.href = "/Dashboard/Login";
            return;
        }

        var isInWishlist = button.classList.contains("fas");
        if (isInWishlist) {
            button.classList.replace("fas", "far");
        }
        else {
            button.classList.replace("far", "fas");
        }
        $.ajax({
            url: '/User/UpdateBookmarks',
            type: 'POST',
            data: { productID: productID, createdBy: createdBy, status: isInWishlist ? 0 : 1 },
            success: function (response) {
                if (response.statusCode != 200) {
                    alert('Error in processing request.');
                }
                else {
                    UpdateWishlistCount();
                }
            },
            error: function () {
                alert('Error in processing request.');
            }
        });
    }
    let totalPages = Math.max(1, Math.ceil(@TotalCount / @itemsPerPage));
    let currentPage = @CurrentPage;
    const visiblePages = 5;
    const itemsPerPage = @itemsPerPage;

    // ---------------- Pagination Rendering ----------------
    function renderPagination() {
        const pagination = document.getElementById('pagination');

        // Remove old page numbers (keep arrows)
        while (pagination.children.length > 2) {
            pagination.removeChild(pagination.children[1]);
        }

        let half = Math.floor(visiblePages / 2);
        let startPage = currentPage - half;
        let endPage = currentPage + half;

        if (startPage < 1) {
            startPage = 1;
            endPage = visiblePages;
        }
        if (endPage > totalPages) {
            endPage = totalPages;
            startPage = Math.max(1, totalPages - visiblePages + 1);
        }

        const insertBefore = pagination.children[pagination.children.length - 1];

        for (let i = startPage; i <= endPage; i++) {
            const li = document.createElement('li');
            li.className = `page-item ${i === currentPage ? 'active' : ''}`;
            li.innerHTML = `<a class="page-link" onclick="goToPage(${i})">${i}</a>`;
            pagination.insertBefore(li, insertBefore);
        }
    }

    // ---------------- Page Navigation ----------------
    function goToPage(page) {
        currentPage = page;
        renderPagination();
        loadPage(page);
    }

    function previousPage() {
        if (currentPage > 1) goToPage(currentPage - 1);
    }

    function nextPage() {
        if (currentPage < totalPages) goToPage(currentPage + 1);
    }

    // ---------------- AJAX Page Load with Filters ----------------
    function loadPage(page) {
        // Collect filter values from main page
        let categoryIds = [];
        $('input[name="category"]:checked').each(function() { categoryIds.push($(this).val()); });

        let ratings = [];
        $('input[name="rating"]:checked').each(function() { ratings.push($(this).val()); });

        let minPrice = $('#minPrice').val();
        let maxPrice = $('#maxPrice').val();
        let city = $('#citySelect').val();
        filters.page = page;
        $("#spinner").removeClass('d-none');

        $.ajax({
            url: '/Dashboard/ProductsList',
            type: 'GET',
            data: filters,
            success: function(data) {
                $('#divPartial').html(data);
                $("#spinner").addClass('d-none');
                $('html, body').animate({ scrollTop: $('#divPartial').offset().top - 100 }, 300);
            },
            error: function() {
                alert('Failed to load products.');
                $("#spinner").removeClass('d-none');
            }
        });
    }

    // Initial render of pagination
    renderPagination();
</script>